---
title: "Appendices"
subtitle: "Habitat heterogeneity and phenotypic variation: Site temperature largely predicts diverse spawning portfolios of an interior Chinook Salmon stock"
output:
  bookdown::pdf_document2:
    extra_dependencies: ["float"]
    latex_engine: lualatex
    theme: cerulean
    toc: true
    number_sections: true
    toc_depth: 2
fontsize: 10pt
date: "`r format(Sys.time(), '%d %B, %Y')`"
editor_options: 
  chunk_output_type: console
bibliography: references.bib
csl: cjfas.csl
---

```{r setup, include=FALSE, cache=FALSE}
# chuck options
knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE, 
  cache = TRUE,
  fig.align = 'center', 
  fig.pos = "H", 
  out.extra = ""
  )

# libraries
library(tidyverse)
library(knitr)
library(kableExtra)
library(here)
library(patchwork)
library(ggh4x)
library(lme4)
library(MuMIn)
library(sjPlot)
library(DHARMa)
library(visdat)
library(skimr)
library(broom)
library(easystats)
library(performance)
library(ggeffects)

# set gpplot theme to bw
theme_set(theme_bw(base_size = 12))

# functions
source(here("R/helper_fxs.R"))
source(here("R/palettes-themes.R"))
```

```{r load-data, cache=FALSE}
# Spawn data -------------------------------------------------------------------
# data were compiled and clean in compile_mfsr_spawn.R and clean_mfsr_spawn.R
spawn_data_cleaned <- read_csv(here("data", "russ_spawn", "mfsr_spawn_cleaned.csv"))

# remove bad data
spawn_data <- spawn_data_cleaned |>
  filter(stream != "Knapp" & stream != "Cape Horn" & year != 2001) |> 
  mutate(
    UNIQUE_ID = as.factor(UNIQUE_ID), 
    year = as.factor(year), 
    stream = as.factor(stream), 
    COMID = as.factor(COMID), 
    DATE = mdy(DATE)
    ) |> 
  select(
    redd_id = UNIQUE_ID, COMID, spawn_date = DATE, stream, year, yday
  )

# Temp data --------------------------------------------------------------------
# temp data (see siegel_mfsr_temps.R)
df_temp <- readRDS(here::here("data/siegel_temperature/siegel_mfsr_comid.RDS"))

xref_comid_stream <- spawn_data |> 
  distinct(COMID, stream) 

# clean up
df_temp <- df_temp |>
  select(COMID, date = tim.date, temp = prd.stream_temp) |> 
  mutate(
    yday = yday(date), 
    year = as_factor(year(date)), 
    COMID = as.character(COMID)) |> 
  filter(COMID %in% spawn_data$COMID) |>
  filter(year %in% c("2002","2003","2004","2005")) |>
  left_join(xref_comid_stream, by = "COMID") 

# summarized temperature data (`out`), see (map_comid_temps.R)
load(here("data", "comid_temps.RData"))

temp_data <- out |>
  filter(period == "before" & duration %in% c(30, 60, 90)) |>
  pivot_wider(
    names_from = "duration", 
    values_from = avg_temp, 
    names_prefix = "temp_"
    ) |> 
  select(redd_id, COMID = comid, spawn_date, temp_30, temp_60, temp_90) |> 
  mutate(redd_id = as_factor(redd_id))


# Flow data --------------------------------------------------------------------
# raw flow data (see flow_calculations.R)
df_flows <- read_csv(here::here("data", "mfsr_flow.csv"))

# get day of year and year
df_flows <- df_flows |> 
  select(date = Date, flow_cfs = Flow) |> 
  mutate(yday = yday(date), year = as_factor(year(date))) |> 
  mutate(flow_csm = flow_cfs * 0.028316846592) |> 
  filter(!year == "2001")

# summarized flow data (see flow_calculations.R)
flow_data <- read_csv(here("data", "spawn_flows.csv"))

# elevation and slope from NHD -------------------------------------------------
df_elev_slope <- readRDS(here("data", "elevslope.rds")) |> 
  as_tibble() |> 
  mutate(mean_elevation = (MAXELEVSMO + MINELEVSMO) / 2 / 100) |> 
  select(COMID, slope = SLOPE, mean_elevation)


# Combine data -----------------------------------------------------------------
model_data <- spawn_data |>
  left_join(flow_data, by = "spawn_date") |> 
  left_join(temp_data |> select(-spawn_date,-COMID), by = "redd_id") |>
  left_join(df_elev_slope |> mutate(COMID = as.factor(COMID)), by = "COMID")

# fix bad slope value
model_data <- model_data |> 
  mutate(slope = ifelse(slope > 0.2, 0.002, slope))

# Finalize data ----------------------------------------------------------------
# df_mod <- model_data |>
#   select(yday, COMID, stream, year, 
#          temp_90_raw = temp_90, 
#          mean_elevation_raw = mean_elevation, 
#          slope_raw = slope) |>
#   mutate(temp_90 = scale2(temp_90_raw), 
#          mean_elevation = scale2(mean_elevation_raw), 
#          slope = scale2(slope_raw))

df_mod <- model_data |>
  select(yday, COMID, stream, year, temp_90, mean_elevation, slope) |> 
  mutate(temp_90 = scale2(temp_90), 
         mean_elevation = scale2(mean_elevation), 
         slope = scale2(slope))
```

\newpage

\renewcommand{\thesection}{A\arabic{section}}
\counterwithin{equation}{section}
\counterwithin{figure}{section}
\counterwithin{table}{section}


# Datasets

## Spawn timing data

Spawn timing data for Chinook salmon were collected from 2001 to 2005 in the MFSR. Because redds were not observed daily, we inferred spawn dates as the initial date (day of year) a completed redd was observed. We removed data from 2001, and data from Knapp Creek and Cape Horn Creek, as these sites were not consistently sampled. The final dataset contained `r nrow(spawn_data)` georeferenced redds (i.e., inferred spawn date) across `r length(unique(spawn_data$COMID))` stream reaches (i.e., COMIDs), nested within six major spawning tributaries that also included Beaver Creek (tributary to Marsh Creek) and Elk Creek (tributary to Bear Valley Creek) to total eight different spawning streams, and spanning four years

We spatially joined each redd GPS location to the NHDPlus Version 2 (Horizon Systems, 2018) to assign stream reaches based on a common identifier (COMID). The COMID is used to link redd data with covariate data associated with the stream reach on which it is located.

**Grouping Structure**

```{r comids}
# How many COMIDs have <5 observations?
n_sparse_COMIDS_5 <- spawn_data |> 
  count(COMID, name = "n_redds") |> 
  filter(n_redds < 5) |> 
  nrow()
n_sparse_COMIDS_2 <- spawn_data |> 
  count(COMID, name = "n_redds") |> 
  filter(n_redds <= 2) |> 
  nrow()

# what percent of comids have <= 1 obervation?
n_perc_1 <- spawn_data |>
  count(COMID, name = "n_redds") |>
  filter(n_redds <= 1) |>
  nrow() / length(unique(spawn_data$COMID)) * 100

n_perc_2 <- spawn_data |>
  count(COMID, name = "n_redds") |>
  filter(n_redds <= 2) |>
  nrow() / length(unique(spawn_data$COMID)) * 100

n_perc_5 <- spawn_data |>
  count(COMID, name = "n_redds") |>
  filter(n_redds <= 5) |>
  nrow() / length(unique(spawn_data$COMID)) * 100
```

The structure of the data is repeated measures on COMIDs, and multiple years, shared across COMIDs within streams. Many `COMIDs` only have 1-2 observation (Figure \@ref(fig:comid-counts)). There are `r n_sparse_COMIDS_5` COMIDs with \<5 redds (`r round(n_perc_5, 1)`%), `r n_sparse_COMIDS_2` with \<= 2. (`r n_perc_2`%). 

```{r comid-counts, fig.width=7, fig.height=3, fig.cap="Number of observations (redds) per COMID."}
# count of comids per stream
p.counts1 <- spawn_data |> 
  distinct(stream, COMID) |> 
  count(stream, name = "n_COMIDs") |> 
  arrange(desc(n_COMIDs)) |> 
  ggplot(aes(x = reorder(stream, -n_COMIDs), y = n_COMIDs, fill = stream)) +
  geom_bar(stat = "identity") +
  # coord_flip() +
  scale_fill_manual(values = cols.streams) + 
  labs(x = "Stream", y = "Count of COMIDs") + 
  theme(legend.position = "none", axis.text.x = element_text(angle=45, hjust=1))

# count of comids with different numbers of redds
p.counts2 <- spawn_data |> 
  count(COMID, name = "n_redds") |> 
  arrange(n_redds) |> 
  ggplot(aes(n_redds)) +
  geom_bar() + 
  scale_y_continuous(breaks = seq(0,10,1)) + 
  labs(x = "Number of redds", y = "Count of COMIDs") 

p.counts1 | p.counts2 + 
  plot_annotation(tag_levels = "A")

# count of redds per comid
# spawn_data |> 
#   count(COMID, name = "n_redds") |> 
#   arrange(n_redds) |> 
#   ggplot(aes(x = reorder(COMID, -n_redds), y = n_redds)) +
#   geom_bar(stat = "identity") 
```

\newpage

**Distribution of spawn timing**

Spawn timing is generally unimodal, with a peak in late August to early September (Figure \@ref(fig:spawn-dist)A). The distribution is slightly left skewed, but the mean and median are similar, indicating low skewness. The variance is low, suggesting no overdispersion. Suggests Poisson family for response if count of spawning events per day, or Gaussian if modeling day of year as continuous. There is also substantial variation in spawn date by stream and year (Fig. \@ref(fig:spawn-dist)B-C; Fig. \@ref(fig:temp-dist-spawn)) and within COMIDs within streams (Fig. \@ref(fig:spawn-comid)).

```{r spawn-dist, message=FALSE, warning=FALSE, results='hide', fig.width=10, fig.height=8, fig.cap = "Histogram and density of spawn timing for all streams and years (A), and by stream (B) and year (C). In panel (A), colored, vertical lines indicate the mean spawn date for each year., and the black vertical line indicated the global mean."}

# calculate mean yday for each year
yr_means <- spawn_data |> 
  group_by(year) |> 
  summarise(mean = mean(yday))

# historgram and density of spawn timing
p1 <- ggplot(spawn_data, aes(x = fixed_date + yday)) +
  geom_histogram(
    aes(y = after_stat(density)),
    bins = 25, fill = "gray80", color = "black"
  ) +
  geom_density(color = "black", size = 1.2, adjust = 1.5) +
  geom_vline(aes(xintercept = fixed_date + mean(yday)),
    color = "black", linetype = "dashed", linewidth = 1.2
  ) +
  geom_vline(
    data = yr_means,
    aes(xintercept = fixed_date + mean, color = year), linewidth = 1.2
  ) +
  scale_color_manual(values = cols.years) +
  scale_x_date(date_breaks = "2 weeks", date_labels = "%d %b") + 
  annotate(
    "text",
    x = fixed_date + 270, y = .06, hjust = 1, vjust = 1, size = 4.5,
    label = paste0
    (
      "mean = ", round(mean(spawn_data$yday), 2), "\n",
      "median = ", round(median(spawn_data$yday), 2), "\n",
      "min = ", round(min(spawn_data$yday), 2), "\n",
      "max = ", round(max(spawn_data$yday), 2), "\n",
      "var = ", round(var(spawn_data$yday), 2), "\n",
      "SD = ", round(sd(spawn_data$yday), 2)
    )
  ) +
  labs(
    title = "Histogram and Density of Spawn Dates",
    x = "",
    y = "Density function\n of spawn dates",
    color = "Year"
  ) +
  theme_bw(base_size = 12) + 
  theme(
    legend.position = "inside",
    legend.position.inside = c(.1, .65),
    legend.title = element_blank(),
    legend.text = element_text(size = 8),
    legend.box.background = element_rect(colour = "black")
  )
# p1

p2 <- spawn_data |> 
  ggplot(aes(x = fixed_date + yday, y = stream, fill = stream)) + 
  ggridges::geom_density_ridges() + 
  scale_fill_manual(values = cols.streams) + 
  expand_limits(y = c(1, 9)) + 
  labs(title = "Spawn Date by Stream", y = "", x = "") +
  theme_bw() +
  guides(fill = "none")


p3 <- spawn_data |> 
  ggplot(aes(x = fixed_date + yday, y = year, fill = year)) + 
  ggridges::geom_density_ridges() + 
  scale_fill_manual(values = cols.years) + 
  expand_limits(y = c(1, 6)) +
  labs(title = "Spawn Date by Year", y = "", x = "") +
  theme_bw() +
  guides(fill = "none")

# panel
# p1 / ((p2 + p3) + 
#   plot_layout(widths = c(1.5,1))) + 
#   plot_annotation(tag_levels = "A")

p1 / (p2 + p3) + 
  plot_annotation(tag_levels = "A")

# save plot
path <- here::here("plots", "Figure_02")
ggsave(
  glue::glue("{path}.pdf"), 
  plot = last_plot(), 
  device = cairo_pdf,
  scale = 1.2, 
  width = 18, 
  height = 15,
  units = "cm" 
  )
pdftools::pdf_convert(
  pdf = glue::glue("{path}.pdf"),
  filenames = glue::glue("{path}.png"),
  format = "png", 
  dpi = 300
  )
```

\newpage 

```{r temp-dist-spawn, fig.width=8, fig.height=8, results='hide', fig.cap= "Histogram and density of Chinook salmon spawn timing across all streams and years (A), by stream (B), and by year (C). In panel (A), the histogram and kernel density illustrate the overall distribution of spawn dates; vertical-colored lines illustrate year-specific means, and the black line depicts the global mean. Spawn timing was generally unimodal, peaking in late August to early September."}

mfsr_by_site <- spawn_data |>
  group_by(stream, yday)

mfsr_all <- spawn_data |>
  summarise(
    median = median(yday),
    percentile_95 = fixed_date + quantile(yday, probs = 0.95),
    percentile_5 = fixed_date + quantile(yday, probs = 0.05)
  )

spawn_data |>
  mutate(across(year, as.character)) |>
  group_by(stream, year) |>
  ggplot(aes(x = fixed_date + yday)) +
  ggh4x::facet_wrap2(~stream, scales = "free_y", ncol = 2) +
  geom_density(
    aes(fill = year),
    alpha = 0.5) +
  geom_density(
    data = mfsr_by_site, alpha = 0, linetype = "dashed", color = "black") +
  geom_vline(
    xintercept = mfsr_all$median, 
    color = "blue", 
    linetype = "dashed") +
  geom_vline(
    xintercept = c(mfsr_all$percentile_95, mfsr_all$percentile_5), 
    color = "red", 
    linetype = "dashed") +
  scale_fill_brewer(palette = "Dark2", name = "Year") +
  scale_x_date(date_breaks = "2 weeks", date_labels = "%d %b") +
  labs(x = "", 
       y = "Density function of spawn dates")
```

\newpage

```{r spawn-comid, message=FALSE, warning=FALSE, fig.width=8, fig.height=8, fig.cap= "Variation in Chinooks salmon spawn timing by COMID within streams."}
spawn_data |>
  ggplot(aes(x = COMID, y = fixed_date + yday)) +
  facet_wrap(~stream, scales = "free_y") +
  geom_boxplot() +
  geom_jitter(aes(color = stream), size = 1.5, alpha = 0.1) +
  scale_color_manual(values = cols.streams) +
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
  coord_flip() +
  labs(x = "", y = "") +
  theme(axis.text.x = element_text(angle = 90)) +
  guides(color = "none")
```

\newpage

**Cumulative proportion of redds over time**

The temporal progression of Chinook salmon spawning activity varied within each stream across the four study years (Figure \@ref(fig:spawn-cum)). The cumulative proportion of redds provides an intuitive measure of the spawning season’s pace and timing. Streams like Marsh and Sulphur exhibit rapid increases, suggesting short, concentrated spawning windows. In contrast, streams like Big and Camas show more gradual increases, indicating a more protracted spawning season. Year-to-year variation is evident in several streams. Overall, this figure highlights both spatial and temporal heterogeneity in spawn timing that underpins the need for models incorporating stream- and year-specific effects.

```{r spawn-cum, fig.width=8, fig.height=6, results='hide', fig.cap="Proportion of cumulative Chinook salmon redds over time (day of year) across years (2002–2005) and streams. Each line represents a different year, with color denoting the year. Stream-specific panels illustrate temporal variation in the progression of spawning activity, as measured by cumulative redd counts normalized to the maximum value in each stream-year combination."}

# Proportional cumulative redds by stream --------------------------------------
# For each year and stream, calculate the prop. cumulative number of redds
props <- spawn_data |> 
  select(year, stream, yday) |>
  group_by(year, stream, yday) |>
  add_count() |> 
  distinct() |> 
  group_by(year, stream) |>
  arrange(year, stream, yday) |>
  mutate(cum_redds = cumsum(n)) |> 
  mutate(cum_redds_p = cum_redds / max(cum_redds))

# Plot pro. cumsums
props |> 
  ggplot(aes(x = fixed_date + yday, y = cum_redds_p, color = as.factor(year))) +
  ggh4x::facet_wrap2(~stream, ncol = 2, scales = "free_y") +
  geom_line(linewidth = 1) + 
  geom_point(size = 1) + 
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.5)) + 
  scale_color_manual(values = cols.years, name = "Year") +
  labs(
    x = "Day of Year",
    y = "Proportion of ccumulative redds",
    color = ""
  ) 

# save plot
path <- here::here("plots", "Figure_03")
ggsave(
  glue::glue("{path}.pdf"), 
  plot = last_plot(), 
  device = cairo_pdf,
  scale = 2, 
  width = 8.8, 
  height = 8,
  units = "cm" 
  )
pdftools::pdf_convert(
  pdf = glue::glue("{path}.pdf"),
  filenames = glue::glue("{path}.png"),
  format = "png", 
  dpi = 300
  )
```

\newpage

## Covariate Derivation and Screening

To identify environmental predictors of Chinook salmon spawn timing, we quantified covariates that describe thermal and physical stream conditions at redd locations. Covariates were selected based on three criteria: (1) demonstrated influence on salmon phenology in prior literature, (2) availability at all redd locations (i.e., COMIDs), and (3) low collinearity with other predictors.

The initial focal covariates included stream temperature (°C), stream discharge (cms), elevation (m), and stream slope (unitless). Elevation and slope were extracted from NHDPlus (Moore et al. 2019).

**Elevation and slope**

Elevation and stream slope data were available at the COMID (stream reach) scale from the NHDPlus Version 2 (Horizon Systems, 2018).

**Stream temperature**

We used modeled daily average stream temperature values predicted at the stream segment (COMID) scale (Siegel et al. 2023). These data were downloaded and filtered to 2002-2005 and for the MFSR. Figure \@ref(fig:plot-temp-regime) shows the modeled thermal regimes for MFSR tributaries.

```{r plot-temp-regime, fig.width=8, fig.height=6, fig.cap="Modeled thermal regimes (2001-2005) for MFSR tributaries. Black line are means, Red ribbon are 40 to 60th percentiles, Grey ribbon are full range."}
# calculate 40 to 60th percentiles and full range for each COMID
df_temp_stream <- df_temp |> 
  group_by(stream, yday) |> 
  summarise(
    mean = mean(temp),
    temp_40 = quantile(temp, probs = 0.4),
    temp_60 = quantile(temp, probs = 0.6),
    temp_min = min(temp),
    temp_max = max(temp), 
    .groups = "drop"
  )

# plot ribbom of 40-60th percentiles and range over yday
df_temp_stream |> 
  ggplot(aes(x = fixed_date + yday)) +
  ggh4x::facet_wrap2(~stream, ncol = 2) +
  geom_ribbon(data = df_temp_stream, aes(ymin = temp_min, ymax = temp_max), fill = "grey") +
  geom_ribbon(data = df_temp_stream, aes(ymin = temp_40, ymax = temp_60), fill = "red") +
  geom_line(aes(y = mean), color = "black") + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_color_brewer(palette = "Accent") +
  labs(
    x = "", 
    y = "Daily water temperature (\u00b0C)",
    color = "Year"
  ) + 
  theme_bw() +
  theme(axis.title.y = ggtext::element_markdown())
```

These modeled temperatures were validated against empirical logger data collected at a subset of sites in the Middle Fork basin, with strong agreement (Pearson correlation coefficient = 0.97; Figure \@ref(fig:isaak-siegel)).

```{r isaak-siegel, fig.width=3, fig.height=2, fig.cap="Comparison of modeled stream temperatures (Siegel et al. 2023) against empirical logger data for the Middle Fork Salmon River."}
isaak_siegel <- readRDS(here("data","siegel_temperature", "Isaak_Siegel_Compare.rds"))
isaak_siegel <- isaak_siegel |> 
  drop_na(DailyMean, Stream_Temp) # remove NAs

### basic mod and correlation
# is_mod <- lm(DailyMean~Stream_Temp, data = isaak_siegel)
# sjPlot::tab_model(is_mod)

# cor(isaak_siegel$DailyMean, isaak_siegel$Stream_Temp)

### plot
isaak_siegel |> 
  ggplot(aes(x= DailyMean , y = Stream_Temp)) +
  geom_point(size = 0.001) +
  geom_abline(intercept = 0, slope = 1, colour = "red") +
  labs(x = "Empirical Temperature", y ="Predicted Temperature") +
  lims(x = c(-2,27), y = c(-2,27)) +
  theme_bw()  +
  annotate("text", x = 10, y = 20, label = paste0("r = ", round(cor(isaak_siegel$DailyMean, isaak_siegel$Stream_Temp), 2)), size = 4)
```

**Discharge (streamflow)**

Stream flow data were compiled from a single USGS Gage lower in the watershed (MF Salmon River at MF Lodge NR Yellow Pine ID - 13309220; Figure \@ref(fig:plot-flow)).

```{r plot-flow, fig.width=8, fig.height=6, fig.cap = "Inter-annual variability in daily discharge (cfs) at MF Lodge USGS Gage 13309220."}
p.flow.1 <- df_flows |> 
  ggplot(aes(x = fixed_date + yday, y = flow_cfs  , color = year)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_color_manual(values = cols.years, name = "Year") +
  labs(
    title = "Linear scale",
    x = "", 
    y = "Mean daily discharge (ft<sup>3</sup> s<sup>-1</sup>)"
  ) + 
  theme_bw() + 
  theme(axis.title.y = ggtext::element_markdown()) + 
  theme(
    legend.position = "inside",
    legend.position.inside =  c(.8, .65), 
    legend.title = element_blank(),
    legend.text = element_text(size = 8),
    legend.box.background = element_rect(colour = "black")
    )

p.flow.2 <- df_flows |> 
  ggplot(aes(x = fixed_date + yday, y = flow_cfs  , color = year)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_log10() +
  scale_color_manual(values = cols.years, name = "Year") +
  labs(
    title = "Log scale",
    x = "", 
    y = "",
    # y = "Mean daily discharge (m<sup>3</sup> s<sup>-1</sup>)"
  ) + 
  theme_bw() + 
  theme(axis.title.y = ggtext::element_markdown())  + 
  guides(color = "none")

# p.flow.1 + p.flow.2 + 
#   plot_layout(guides = "collect") + 
#   plot_annotation(title = "Measured discharge at MF Lodge, USGS Gage 13309220")

# calculate 40 to 60th percentiles and full range for each COMID
tmp <- df_flows |> 
  group_by(yday) |>
  summarise(
    mean = mean(flow_cfs),
    flow_40 = quantile(flow_cfs, probs = 0.4),
    flow_60 = quantile(flow_cfs, probs = 0.6),
    flow_10 = quantile(flow_cfs, probs = 0.1),
    flow_90 = quantile(flow_cfs, probs = 0.9), 
    .groups = "drop"
  )

# plot ribbom of 40-60th percentiles and range over yday
p.flow.3 <- tmp |> 
  ggplot(aes(x = fixed_date + yday)) +
  geom_ribbon(data = tmp, aes(ymin = flow_10, ymax = flow_90), fill = "grey") +
  geom_ribbon(data = tmp, aes(ymin = flow_40, ymax = flow_60), fill = "blue") +
  geom_line(aes(y = mean), color = "black") + 
  scale_color_brewer(palette = "Accent") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_log10() +
  labs(
    # title = "Measured discharge at MF Lodge, USGS Gage 13309220",
    subtitle = "Black line = mean, blue ribbon = 40 - 60th percentiles, Grey ribbon = full range",
    x = "", 
    y = "Log Daily discharge (ft<sup>3</sup> s<sup>-1</sup>)",
    color = "Year"
  ) + 
  theme_bw() +
  theme(axis.title.y = ggtext::element_markdown())


(p.flow.1 + p.flow.2 ) / p.flow.3 + 
  # plot_annotation(title = "Measured discharge at MF Lodge, USGS Gage 13309220") + 
  plot_annotation(tag_levels = "A")
```

**Time-windowed temp and flow metrics**

For each redd, we computed several time-windowed summaries of temperature and flow relative to the inferred spawn date:

-   *Antecedent metrics*: average conditions over 30, 60, and 90 days preceding the spawn date
-   *Spanning metrics*: averages over time windows centered on the spawn date,
-   *Post-spawn metrics*: 30-, 60-, and 90-day averages following the spawn date,
-   *Time-invariant metrics*: summaries calculated relative to a fixed calendar date (e.g., August 1) representing an approximate onset of the spawning window.

The time invariant and after metrics were omitted from further consideration as preliminary data exploration showed weak if any relationship with spawn timing.

\newpage

# Exploratory Data Analysis

## Bivariate relationships

We did exploratory data analysis on the compiled dataset to identify candidate covariates for inclusion in model selection. Bivariate relationships between spawn date (`yday`) and continuous predictors (Figure \@ref(fig:plot-covars)), and pairwise correlations between all continuous covariates (Figure \@ref(fig:colin)), are shown below.

```{r plot-covars, fig.width=6,  fig.height=5, fig.cap = "Bivariate relationships between spawn date (`yday`) and continuous covariates. Solid lines are linear fits."}
covariates <- c(
  "temp_30", 
  "temp_60", 
  "temp_90",
  "flow_30", 
  "flow_60", 
  "flow_90",
  "slope",
  "mean_elevation"
  )
plots <- map(covariates, ~ plot_covariate(model_data, .x))
gridExtra::grid.arrange(grobs = plots, ncol = 3)
```

```{r colin, cache=TRUE, fig.width=8, fig.height=7, fig.cap="Pairwise correlations between continuous covariates."}
model_data |> 
  select(temp_30, temp_60, temp_90, flow_30, flow_60, flow_90, mean_elevation, slope) |> 
  GGally::ggpairs()
```

**Takeaways from Figures** \@ref(fig:plot-covars) **and** \@ref(fig:colin):

Amoung temperature variables, `temp_90` clearly shows the strongest relationship with spawn date (Figure \@ref(fig:plot-covars)), and is highly colinear with `temp_30` and `temp_60` (Figure \@ref(fig:colin)).

The is a weak negative relationship between `mean_elevation` and `yday` (Figure \@ref(fig:plot-covars)), and it is weakly correlated with `temp_90` (0.31, Figure \@ref(fig:colin)).

-   `flow_30` = decaying exponential, obvious year effect
-   `flow_60` = ditto
-   `flow_90` = inflections, year effect clear
-   `slope` = no relationship

\newpage 

## Stream temperature (temp_90)

```{r plot-temp-90, fig.width=8, fig.height=4, fig.cap = "Relationship between 90 day antecedent stream temperature and spawn date by stream and year. Solid lines are linear fits."}

p.t90.1 <- model_data |> 
  ggplot(aes(temp_90, fixed_date + yday, color = stream)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
  scale_color_manual(values = cols.streams) 

p.t90.2 <- model_data |> 
  ggplot(aes(temp_90, fixed_date + yday, color = year)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
  scale_color_manual(values = cols.years) 

p.t90.3 <- model_data |> 
  ggplot(aes(temp_90, fixed_date + yday, color = stream)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  ggh4x::facet_wrap2(~year, scales = "free") +
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
  scale_color_manual(values = cols.streams) + 
  labs(
    x = "90-day mean temperature (°C)", 
    y = "Spawn Date",
    color = "Stream"
  )

# (p.t90.1 | p.t90.2) / p.t90.3 + 
#   plot_layout(guides = "collect") +
#   plot_annotation(tag_levels = "A")
p.t90.3
```

Given observed positive relationships (Figure \@ref(fig:plot-temp-90)), we evaluated the role of `temp_90` in explaining variation in Chinook salmon spawn timing:

```{r t90-lm, echo=TRUE}
# temp_90 models
m.t90.1 <- lmer(yday ~ (1|COMID), data = df_mod, REML = FALSE)
m.t90.2 <- lmer(yday ~ temp_90 + (1|COMID), data = df_mod, REML = FALSE)
m.t90.3 <- lmer(yday ~ temp_90 + I(temp_90^2) + (1|COMID), data = df_mod, REML = FALSE)
```

The model with a quadratic effect of temperature (`m.t90.3`) improved dramatically over the null (intercept-only) model and linear effect (Table \@ref(tab:t90-aic)), and boosting both conditional and marginal R² (Table \@ref(tab:t90-perf)). This confirms a strong, nonlinear effect of pre-spawn temperature on spawn timing (Figure \@ref(fig:t90-relate)).

```{r t90-aic}
compare_aic(m.t90.1, m.t90.2, m.t90.3) |> 
  kable(caption = "AIC comparison of linear mixed models relating spawn date (`yday`) to `temp\\_90`.") |> 
  kable_styling(latex_options = "hold_position")
```

```{r t90-perf}
compare_performance(m.t90.1, m.t90.2, m.t90.3, rank = TRUE, metrics = "common") |> 
  select(-Model, -AIC_wt, -BIC_wt) |> 
  kable(caption = "Model performance of linear mixed models relating spawn date (`yday`) to `temp\\_90`.") |> 
  kable_styling(latex_options = "hold_position")
```

```{r t90-relate, fig.width=8, fig.height=3, fig.cap="Marginal effect of 90 day antecedent stream temperature on spawn timing for (A) `m.t90.2` and (B) `m.t90.3`."}
estimate_relation(m.t90.2) |> 
  plot(show_data = TRUE) | 
estimate_relation(m.t90.3) |> 
  plot(show_data = TRUE) + 
  plot_annotation(tag_levels = "A")
```

Next, we add in stream and year as main effects, and then interactions:

```{r t90-lm2, echo=TRUE}
# temp + stream + year models
m.t90.4 <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + (1|COMID), data = df_mod, REML = FALSE)
m.t90.5 <- lmer(yday ~ temp_90 + I(temp_90^2) + year + (1|COMID), data = df_mod, REML = FALSE)
m.t90.6 <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + year + (1|COMID), data = df_mod, REML = FALSE)
m.t90.7 <- lmer(yday ~ temp_90 * stream + I(temp_90^2) + year + (1|COMID), data = df_mod, REML = FALSE)
m.t90.8 <- lmer(yday ~ temp_90 * year + I(temp_90^2) + stream + (1|COMID), data = df_mod, REML = FALSE)
```

```{r t90-aic2}
compare_aic(m.t90.3, m.t90.4, m.t90.5, m.t90.6, m.t90.7, m.t90.8) |> 
  kable(caption = "AIC comparison of linear mixed models relating spawn timing to temperature.") |> 
  kable_styling(latex_options = "hold_position")
```

```{r t90-perf2}
compare_performance(m.t90.3, m.t90.4, m.t90.5, m.t90.6, m.t90.7, m.t90.8, rank = TRUE, 
                    metrics = "common") |> 
  select(-Model, -AIC_wt, -BIC_wt) |> 
  kable(caption = "Model performance of linear mixed models relating spawn timing to temperature.") |> 
  kable_styling(latex_options = "hold_position")
```

Adding stream (`m.t90.4`) or year (`m.t90.5`) individually improved model fit relative to `m.t90.3`, but year alone (`m.t90.5`) performed better than stream alone (`m.t90.4`) (Table \@ref(tab:t90-aic2)).

Combining stream and year additively (`m.t90.6`) provided further improvement in AIC, along with the best marginal R2 and RMSE (Table \@ref(tab:t90-perf2)). This suggests that both stream and year provide meaningful structure in explaining variation in spawn timing. Adding the interaction between temperature and stream (`m.t90.7`) increased complexity, slightly lowered the marginal R2, and has high multicollinearity (VIF \~15).

Adding the interaction between temperature and year (`m.t90.8`) gave the lowest AIC overall but had the lowest marginal R² of all models tested. This means that while the model “fit” the data better on paper (AIC), it did so by overfitting or by capturing year-to-year idiosyncrasies that may not generalize well to new data (suspicious marginal effect, Figure \@ref(fig:t90-relate2)).

```{r t90-relate2, fig.width=5, fig.height=3, fig.cap="Marginal effect (`m.t90.8`) of 90 day antecedent stream temperature on spawn timing."}

# car::vif(m.t90.8)
# car::vif(m.t90.7)
# car::vif(m.t90.6)
# car::vif(m.t90.5)
# check_model(m.t90.8)
# check_model(m.t90.7, check = "vif")

# vizdata <- get_datagrid(df_mod, by = c("temp_90", "stream"), length = 100, preserve_range = TRUE)
# vizdata$Predicted <- get_predicted(m.t90.7, vizdata)
# vizdata
# ggplot(df_mod, aes(x = temp_90, y = yday, color = stream)) +
#   geom_point() +
#   geom_line(data = vizdata, aes(y = Predicted), linewidth = 1)
# 
tmp <- estimate_relation(m.t90.8, by = c("temp_90"), length = 100, preserve_range = TRUE)
# tmp
plot(tmp, show_data = TRUE)
```

The suspicious curvature in the marginal effect plot of `m.t90.8` (showing an unrealistic predicted relationship between `temp_90` and `yday`) confirms the risk of confounding or overfitting with interaction terms—particularly given that the random intercepts already capture substantial site-level variation.

Given the trade-offs, model `m.t90.6` emerged as the best compromise: it retained additive main effects of temperature, stream, and year, had high conditional and marginal R², moderate AIC, low RMSE, and avoided high multicollinearity.

### Summary

The exploratory analysis of temperature effects on spawn timing revealed a clear, nonlinear relationship between pre-spawn temperature and the day of year when spawning occurs. A quadratic term for temperature consistently improved model fit over linear-only specifications. When adding stream and year as main effects, model performance improved substantially, with both factors accounting for additional variation in spawn timing. However, introducing interaction terms between temperature and either stream or year led to either inflated multicollinearity (VIFs \> 10) or implausible model predictions, indicating potential overfitting. Although the temperature-by-year interaction model (`m.t90.8`) had the lowest AIC, it yielded a counterintuitive relationship between temperature and spawn timing. Therefore, the additive model with quadratic temperature and main effects of stream and year (`m.t90.6`) was selected as the preferred model, balancing goodness-of-fit with interpretability and biological realism.

## `mean_elevation`

Figure \@ref(fig:elev-plots) shows the relationship between between (A) `mean_elevation` and `temp_90` by stream and (B) `mean_elevation` and `yday` (spawn date) by stream and year.

```{r elev-plots, fig.width=6, fig.height=4, fig.cap = "Relationship between (A) mean\\_elevation and temp\\_90 by stream and (B) mean\\_elevation and spawn timing by stream and year. Solid lines are linear fits."}
p.elev.temp <- model_data |>
  ggplot(aes(mean_elevation, temp_90, color = stream)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = cols.streams) +
  labs(
    x = "Mean elevation (m)", color = "Stream",
    y = "90-day mean\n temperature (°C) pre spawn"
  )

p.elev.yday <- model_data |> 
  ggplot(aes(mean_elevation, fixed_date + yday, color = stream)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  # ggh4x::facet_wrap2(~year, scales = "free") +
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
  scale_color_manual(values = cols.streams) +
  labs(
    x = "Mean Elevation",color = "Stream",
    y = "Spawn Date"
    )

# p.elev.yday_highelev <- model_data |> 
#   filter(stream %in% c("Bear Valley","Marsh","Elk","Beaver")) |> 
#   ggplot(aes(mean_elevation, fixed_date + yday, color = stream)) + 
#   geom_point() + 
#   geom_smooth(method = "lm", se = FALSE) + 
#   # ggh4x::facet_wrap2(~year, scales = "free") +
#   scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
#   scale_color_manual(values = cols.streams) +
#   labs(
#     x = "Mean Elevation",color = "Stream",
#     y = "Spawn Date"
#     )
# 
# p.elev.yday_lowelev <- model_data |> 
#   filter(!stream %in% c("Bear Valley","Marsh","Elk","Beaver")) |> 
#   ggplot(aes(mean_elevation, fixed_date + yday, color = stream)) + 
#   geom_point() + 
#   geom_smooth(method = "lm", se = FALSE) + 
#   # ggh4x::facet_wrap2(~year, scales = "free") +
#   scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
#   scale_color_manual(values = cols.streams) +
#   labs(
#     x = "Mean Elevation",color = "Stream",
#     y = "Spawn Date"
#     )

p.elev.temp / p.elev.yday + 
  plot_layout(guides = "collect", heights = c(1,1)) +
  plot_annotation(tag_levels = "A")

# p.elev.yday_highelev / p.elev.yday_lowelev + 
#   plot_layout(guides = "collect", heights = c(1,1)) +
#   plot_annotation(tag_levels = "A")
```

We evaluated the role of mean elevation in explaining variation in Chinook salmon spawn timing:

```{r elev-lm, echo=TRUE}
# mean elevation models
m.ele.1 <- lmer(yday ~ (1|COMID), data = df_mod, REML = FALSE)
m.ele.2 <- lmer(yday ~ mean_elevation + (1|COMID), data = df_mod, REML = FALSE)
m.ele.3 <- lmer(yday ~ mean_elevation + stream + (1|COMID), data = df_mod, REML = FALSE)
m.ele.4 <- lmer(yday ~ mean_elevation + year + (1|COMID), data = df_mod, REML = FALSE)
m.ele.5 <- lmer(yday ~ mean_elevation + stream + year + (1|COMID), data = df_mod, REML = FALSE)
m.ele.6 <- lmer(yday ~ mean_elevation * stream + (1|COMID), data = df_mod, REML = FALSE)
m.ele.7 <- lmer(yday ~ mean_elevation * year + (1|COMID), data = df_mod, REML = FALSE)
```

Including mean elevation as a main effect improved model fit (ΔAIC = 19 between `m.ele.1` and `m.ele.2`). The best-supported model (`m.ele.5`) included mean elevation alongside stream and year (ΔAIC = 281 between `m.ele.2` and `m.ele.5`), with moderate collinearity (VIFs \~6), suggesting that mean elevation can contribute to explaining spawn timing when controlling for stream and year.

However, adding interactions with stream or year substantially increased model complexity and collinearity, as evidenced by extremely high VIFs (\>45). Given the known inverse relationship between elevation and temperature across streams (Figure \@ref(fig:elev-plots)A), caution is warranted when later incorporating both elevation and temperature in the same model.

```{r elev-aic}
compare_aic(m.ele.1, m.ele.2, m.ele.3, m.ele.4, m.ele.5, m.ele.6, m.ele.7) |> 
  kable(caption = "AIC comparison of linear mixed models relating spawn timing to mean\\_elevation.") |> 
  kable_styling(latex_options = "hold_position")
# tab_model(m.ele.5, m.ele.6, m.ele.3, m.ele.7)
```

```{r elev-perf}
compare_performance(m.ele.1, m.ele.2, m.ele.3, m.ele.4, m.ele.5, m.ele.6, m.ele.7, rank = TRUE) |> 
  select(-Model, -AIC_wt, -BIC_wt) |> 
  kable(caption = "Model performance of linear mixed models relating spawn timing to mean\\_elevation.") |> 
  kable_styling(latex_options = "hold_position")
```

```{r elev-vif-m5}
car::vif(m.ele.5) |> 
  kable(caption = "Variance inflation factors for model m.ele.5.") |> 
  kable_styling(latex_options = "hold_position")
```

```{r elev-vif-m6}
car::vif(m.ele.6) |> 
  kable(caption = "Variance inflation factors for model m.ele.6.") |> 
  kable_styling(latex_options = "hold_position")
```

## `slope`

`slope` is not related to `yday` (Figure \@ref(fig:plot-slope)A), though there is some association between `slope` and `yday` when considering stream (Figure \@ref(fig:plot-slope)B). We will likely drop slope.

```{r plot-slope, fig.width=8, fig.height=3, fig.cap = "Bivariate relationship between `slope` and spawn date (A) and by stream (B). Solid lines are linear fits."}
model_data |> 
  filter(slope < .2) |>
  ggplot(aes(slope, fixed_date + yday)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
  labs(x = "Slope", y = "Spawn Date") | 

model_data |> 
  filter(slope < .2) |>
  ggplot(aes(slope, fixed_date + yday, color = stream)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  # ggh4x::facet_wrap2(~year, scales = "free") +
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
  scale_color_manual(values = cols.streams) +
  labs(x = "Slope", y = "Spawn Date") + 
  plot_annotation(tag_levels = "A")
```

```{r slope-lm, eval=FALSE}
m_slope1 <- lm(yday ~ slope, data = model_data)
m_slope2 <- lm(yday ~ slope + stream, data = model_data)

compare_performance(m_slope1, m_slope2, rank = TRUE) |> 
  kable(caption = "Model comparison of linear models relating spawn date (`yday`) to `slope`.") |> 
  kable_styling(latex_options = "hold_position")

# tab_model(
#   m_slope1, m_slope2, dv.labels = c("Slope only", "Slope + stream"),
#   title = "(\\#tab:slope-lm) Parameter estimates for linear model relating spawn date (`yday`) to `slope`."
#   )
```

## `flow_90`

Because flow data are not COMID- or stream-specific, it makes sense to think about and represent flow as an out-of-basin year effect that determines when adults make it back to the MFSR and initially onto the spawning grounds. The strong correlation between `flow_90` and `year` can be seen clearly in (Figure \@ref(fig:plot-flow-met)A).

```{r plot-flow-met, fig.width=8, fig.height=3, fig.cap = "Spawn timing vs. 90-day mean discharge pre spawn at MF Lodge."}
ggplot(model_data, aes(x = flow_90, y = fixed_date + yday, color = year)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = cols.years) + 
  labs(x = "90-day mean\nflow (CFS) pre spawn", y = "Spawn date") + 
  theme(legend.position = "right") + 

ggplot(model_data, aes(x = flow_90, y = fixed_date + yday, color = stream)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = cols.streams) + 
  labs(x = "90-day mean\n flow (CFS) pre spawn", y = "Spawn date") + 
  theme(legend.position = "right") + 
  
  plot_annotation(tag_levels = "A")
```

Next we compare the following simple linear models to examine functional structure:

```{r flow-mods, echo=TRUE}
# flow_90 models
m.flow.1 <- lm(yday ~ flow_90, data = model_data)
m.flow.2 <- lm(yday ~ I(flow_90^2), data = model_data)
m.flow.3 <- lm(yday ~ flow_90 + year, data = model_data)
m.flow.4 <- lm(yday ~ flow_90 + year + stream, data = model_data)
m.flow.5 <- lm(yday ~ flow_90 * stream, data = model_data)
m.flow.6 <- lm(yday ~ flow_90 * stream + year, data = model_data)
m.flow.7 <- lm(yday ~ flow_90 * year + stream, data = model_data)
m.flow.8 <- lm(yday ~ flow_90 * stream + I(flow_90^2), data = model_data)
m.flow.9 <- lm(yday ~ flow_90 * stream + year + I(flow_90^2), data = model_data)
```

```{r flow-aic}
compare_performance(m.flow.1, m.flow.2, m.flow.3, m.flow.4, m.flow.5, m.flow.6, m.flow.7, m.flow.8, m.flow.9, rank = TRUE) |> 
  select(-Model, -AIC_wt, -BIC_wt) |> 
  kable(caption = "Model performance of linear models relating spawn date (`yday`) to `flow\\_90`.") |> 
  kable_styling(latex_options = "hold_position")
```

```{r flow-params}
parameters(m.flow.7) |> 
  select(-CI, -t, -df_error) |> 
  kable(
    caption = "Parameter estimates for m.flow.7"
  ) |> 
  kable_styling(latex_options = "hold_position")
```

```{r flow-vif, fig.width=6, fig.height=2, fig.cap="Variance inflation factors for model m.flow.7"}
check_model(m.flow.7, check = "vif")
```

AIC scores suggest `m.flow.7` is best model (Table \@ref(tab:flow-aic)). However, while the R\^2 value is `r round(summary(m.flow.7)$r.squared, 2)`, the parameter estimate for `flow_90` has is incredibly small and most variation is now attributed to the year contrasts (Table \@ref(tab:flow-params)). Thus, `flow_90` is clearly confounded with `year`, and confirmed by high Variance Inflation Factor (VIF) scores (Figure \@ref(fig:flow-vif)).

### Why `flow_90` is problematic

Not spatially resolved

-   We are modeling spawn timing at the redd level (COMID/stream)
-   But `flow_90` is calculated from a single downstream gauge, and applied to all redds
-   This assumes flow conditions are identical across all sites
-   Including it gives the illusion of spatially resolved variation that isn’t there

Correlated with year

-   Since `flow_90` varies mostly across years, it is strongly confounded with year
-   Any flow-related signal is probably already captured by your year fixed effect
-   Including both `flow_90` and year risks collinearity, and may produce misleading inferences

Spawn-time aligned flow does not equal experienced flow

-   While `flow_90` is aligned to each redd’s spawn date, it still reflects a lower-basin gauge, not the actual hydrologic conditions experienced at the redd site
-   So it might be precisely wrong — aligned in time but irrelevant in space

**Recommendation**: Drop `flow_90` from model.

Although we initially considered including 90-day mean streamflow (`flow_90`) as a predictor of spawn timing, this variable was ultimately excluded due to concerns about ecological validity and model overfitting. Stream flow data were derived from a single downstream USGS gauge and did not capture spatial variation across the study streams or reaches. Moreover, because `flow_90` was closely aligned with year, it introduced strong collinearity with the year effect and risked attributing site-level variation to flow patterns not actually experienced by individual redds. As such, we excluded `flow_90` to avoid misleading inference.

\newpage

# Data Anlaysis

The final analysis dataset includes (Table \@ref(tab:final-dataset)):

-   `yday`: spawn date, continuous response variable
-   `comid`, `stream`, `year`: grouping variables
-   `temp_90`: 90-day mean temperature pre-spawn, continuous predictor variable
-   `slope` and `mean_elevation`: provisionally retaining continuous predictor variable

```{r final-dataset}
df_mod |> 
  slice_head(n = 5) |> 
  kable(
    caption = "Final dataset for modeling, first 5 rows."
  ) |> 
  kable_styling(latex_options = "hold_position")
```

We used linear mixed-effects models to evaluate environmental predictors of Chinook salmon spawn timing, with redd observation day-of-year (`yday`) as the response variable. We scaled the continuous covariates to have a mean of 0 and standard deviation of 1 to assist convergence and interpretation. `COMID` will be included in all models as a random (intercept) effect to account for repeated measures on `COMID`s. `Stream` will be treated as a fixed effect to compare average effects across streams, and `year` as a fixed effect to compare average effects across years. Further, based on exploratory analysis and biological expectations of nonlinear thermal responses, temperature effects were modeled using both linear and quadratic terms for the 90-day average stream temperature prior to spawning (`temp_90` and `I(temp_90^2)`).

## Initial Model Selection

We fit 31 additive models representing all combinations of fixed effects: `temp_90`, `stream`, `year`, `slope`, and `mean_elevation`. Model selection was performed using AIC, and model fit was evaluated using marginal and conditional R², RMSE, and intraclass correlation coefficients (ICC). 

```{r lm-quad, echo=TRUE, eval=TRUE}
m1 <- lmer(yday ~ temp_90 + I(temp_90^2) + (1|COMID), data = df_mod, REML = FALSE)
m2 <- lmer(yday ~ stream + (1|COMID), data = df_mod, REML = FALSE)
m3 <- lmer(yday ~ year + (1|COMID), data = df_mod, REML = FALSE)
m4 <- lmer(yday ~ mean_elevation + (1|COMID), data = df_mod, REML = FALSE)
m5 <- lmer(yday ~ slope + (1|COMID), data = df_mod, REML = FALSE)

m6  <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + (1|COMID), data = df_mod, REML = FALSE)
m7  <- lmer(yday ~ temp_90 + I(temp_90^2) + year + (1|COMID), data = df_mod, REML = FALSE)
m8  <- lmer(yday ~ temp_90 + I(temp_90^2) + mean_elevation + (1|COMID), data = df_mod, REML = FALSE)
m9  <- lmer(yday ~ temp_90 + I(temp_90^2) + slope + (1|COMID), data = df_mod, REML = FALSE)
m10 <- lmer(yday ~ stream + year + (1|COMID), data = df_mod, REML = FALSE)
m11 <- lmer(yday ~ stream + mean_elevation + (1|COMID), data = df_mod, REML = FALSE)
m12 <- lmer(yday ~ stream + slope + (1|COMID), data = df_mod, REML = FALSE)
m13 <- lmer(yday ~ year + mean_elevation + (1|COMID), data = df_mod, REML = FALSE)
m14 <- lmer(yday ~ year + slope + (1|COMID), data = df_mod, REML = FALSE)
m15 <- lmer(yday ~ mean_elevation + slope + (1|COMID), data = df_mod, REML = FALSE)

m16 <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + year + (1|COMID), data = df_mod, REML = FALSE)
m17 <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + mean_elevation + (1|COMID), data = df_mod, REML = FALSE)
m18 <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + slope + (1|COMID), data = df_mod, REML = FALSE)
m19 <- lmer(yday ~ temp_90 + I(temp_90^2) + year + mean_elevation + (1|COMID), data = df_mod, REML = FALSE)
m20 <- lmer(yday ~ temp_90 + I(temp_90^2) + year + slope + (1|COMID), data = df_mod, REML = FALSE)
m21 <- lmer(yday ~ temp_90 + I(temp_90^2) + mean_elevation + slope + (1|COMID), data = df_mod, REML = FALSE)
m22 <- lmer(yday ~ stream + year + mean_elevation + (1|COMID), data = df_mod, REML = FALSE)
m23 <- lmer(yday ~ stream + year + slope + (1|COMID), data = df_mod, REML = FALSE)
m24 <- lmer(yday ~ stream + mean_elevation + slope + (1|COMID), data = df_mod, REML = FALSE)
m25 <- lmer(yday ~ year + mean_elevation + slope + (1|COMID), data = df_mod, REML = FALSE)

m26 <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + year + mean_elevation + (1|COMID), data = df_mod, REML = FALSE)
m27 <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + year + slope + (1|COMID), data = df_mod, REML = FALSE)
m28 <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + mean_elevation + slope + (1|COMID), data = df_mod, REML = FALSE)
m29 <- lmer(yday ~ temp_90 + I(temp_90^2) + year + mean_elevation + slope + (1|COMID), data = df_mod, REML = FALSE)
m30 <- lmer(yday ~ stream + I(temp_90^2) + year + mean_elevation + slope + (1|COMID), data = df_mod, REML = FALSE)

m31 <- lmer(yday ~ temp_90 + I(temp_90^2) + stream + year + mean_elevation + slope + (1|COMID), data = df_mod, REML = FALSE)
```

```{r lm-tabs}
aic_tab <- compare_aic(
  m1,m2,m3,m4,m5,m6,m7,m8,m9,m10,m11,m12,m13,m14,m15,m16,m17,
    m18,m19,m20,m21,m22,m23,m24,m25,m26,m27,m28,m29,m30,m31#,m26a
  )
perf_tab <- compare_performance(
  m1,m2,m3,m4,m5,m6,m7,m8,m9,m10,m11,m12,m13,m14,m15,m16,m17,
  m18,m19,m20,m21,m22,m23,m24,m25,m26,m27,m28,m29,m30,m31,#m26a,
  estimator = "ML", rank = TRUE, metrics = "common"
  ) 

lm_tab <- aic_tab |> 
  left_join(perf_tab, by = c("Model"="Name")) |> 
  select(Model, df, AIC, delta_AIC=delta, R2_marginal, R2_conditional, RMSE, ICC) |> 
  mutate(across(where(is.numeric), ~ round(., 3))) |>
  write_csv(here::here("tables","lm-model-comparison.csv"))
```

```{r aic-tab}
lm_tab |>
  slice_head(n = 10) |>
  kable(
    caption = "AIC selection performance metrics for additive linear models; top 10 of 31 shown."
  ) |> 
  kable_styling(latex_options = "hold_position")
```

```{r params-lm, eval=FALSE}
tab_model(
  m31, m26, m27, m16, m28, 
  title = "(\\#tab:params-lm) Parameter estimates for top 5 additive linear models.",
  dv.labels = c(
    "m31: Full model", "m26: No slope", "m27: No elevation", "m16: No elevation or slope", "m28: No year"),
  CSS = list(
    css.table = "+font-size: 0.6em; +font-family: Arial;",
    css.footnote = "font-size: 0.8em;"
    )
  )
```

Based on AIC, the best-fitting model was `m26`, though its improvement in AIC and performance over `m31`, the full model which includes `slope`, was modest (Table \@ref(tab:aic-tab). Suggests little benefit to including `slope` as a predictor.

`m27`, which excludes `mean_elevation`, had substantially worse AIC and performance than `m26` and `m31`, indicating that elevation contributes meaningfully to explaining spawn timing variation.

Model `m16`, which excludes both `mean_elevation` and `slope`, had nearly identical predictive accuracy (RMSE) and higher conditional R² compared to `m26` and `m31`, despite a slightly lower (0.73 vs 0.78) marginal R². The 117-point AIC difference between `m16` and `m26` likely reflects subtle improvements in likelihood fit due to topographic covariates.

Visual inspection of partial (model-based) relationships (Figure \@ref(fig:lm-plot) B)) revealed that the modeled elevation effect was inconsistent with ecological expectations.

```{r lm-plot, fig.width=8, fig.height=3, fig.cap="Predicted relationship (red line) between spawn date (`yday`) and (A) `temp\\_90`, (B) `mean\\_elevation`."}
a <- plot_model(
  m26, type = "eff", terms = c("temp_90"), show.data = TRUE,
  title = "`m26`, `temp_90`"
  ) + labs(y = "Predicted\nspawn date")

b <- plot_model(
  m26, type = "eff", terms = c("mean_elevation"), show.data = TRUE,
  title = "`m26`, `mean_elevation`"
  ) + labs(y = "")

a + b +
  plot_annotation(tag_levels = "A")
```

In this case, `m26` is picking up a positive association: after controlling for temperature and stream identity, higher-elevation reaches are predicted to spawn later. This is contrary to the observed negative relationships between elevation, temperature, and spawn timing in several streams (Figure \@ref(fig:elev-plots)). This could reflect either (a) a real but subtle ecological effect, or (b) statistical artifact from collinearity/confounding.

a)  There are some reasons a residual positive elevation effect might make sense:

-   Hydrology and snowmelt: At higher elevations, cooler conditions might delay snowmelt-driven flow cues, potentially pushing back spawning independent of temperature.

-   Population differences: If higher-elevation reaches host subpopulations adapted to shorter growing seasons, they might time spawning later to avoid fry emerging into very harsh winter conditions.

-   Migration lags: Reaches further upstream (which often correspond to higher elevations) could simply take longer for fish to reach, even if temperatures are similar.

But these are second-order hypotheses—we’d need strong ecological justification to lean on them.

b)  Statistical red flags

-   The positive effect could just as easily be an artifact of collinearity. Elevation and temperature are tightly coupled in your dataset. Once you partial out temperature, the remaining variation in elevation is limited and unstable.

-   The fact that predicted vs. observed plots showed inconsistent elevation effects across streams (your Figure elev-plots) suggests this may not be a robust, generalizable signal.

Variance inflation factors (VIFs) from `m26` also indicated moderate collinearity between elevation and stream (VIF = 6.50 and 6.48, respectively). Elevation was strongly confounded with stream identity in our dataset (Figure \@ref(fig:elev-plots)), with high-elevation streams showing considerable overlap in spawn timing and temperature.

```{r m26-vif, eval=FALSE}
car::vif(m26)
check_model(m26, check = c("vif"))
```

So, we acknowledge both interpretations:

-   Statistically: The positive elevation effect emerges after controlling for temperature, but it is likely confounded by collinearity.

-   Ecologically: A true positive effect could be consistent with delayed migration, snowmelt-driven cues, or subpopulation adaptations, but our dataset can’t fully disentangle these mechanisms.

-   Conclusion: Because the elevation effect runs counter to raw data patterns and shows signs of confounding, we made the conservative decision to omit it from the final model set.

## Targeted model comparison

We compared our top additive model (`m16`) to a series of increasingly flexible models to evaluate the contribution of random slopes and temperature nonlinearity.

### Random slopes for `temp_90`

To account for potential variation in temperature sensitivity across sites, we extended `m16` to include **COMID-specific random slopes for `temp_90`**, yielding a model with the same fixed effects but with the random structure `(1 + temp_90 | COMID)`. Because the random effects structure differed, we fit both models using restricted maximum likelihood (REML).

```{r m16-rs, echo=TRUE}
m16 <- lmer(
  yday ~ temp_90 + I(temp_90^2) + stream + year + (1 | COMID),
  data = df_mod, REML = TRUE
  )
m16_rs <- lmer(
  yday ~ temp_90 + I(temp_90^2) + stream + year + (1 + temp_90 | COMID), 
  data = df_mod, REML = TRUE
  )
```

```{r m16-rs-tabs}
aic_tab <- compare_aic(
  m16, m16_rs
  )
perf_tab <- compare_performance(
  m16, m16_rs,
  rank = TRUE, metrics = "common"
  )

lm_tab <- aic_tab |> 
  left_join(perf_tab, by = c("Model"="Name")) |> 
  select(Model, df, AIC, delta_AIC=delta, R2_marginal, R2_conditional, RMSE, ICC) |> 
  mutate(across(where(is.numeric), ~ round(., 3))) |>
  write_csv(here::here("tables","lm-model-comparison-ran-slopes.csv"))
```

```{r m16-rs-aic}
lm_tab |>
  kable(
    caption = "Model selection for `m16` vs. `m16\\_rs`."
  ) |> 
  kable_styling(latex_options = "hold_position")
```

```{r params, eval=FALSE}
tab_model(
  m16, m16_rs, 
  dv.labels = c("m16_rs", "m16_rs"), 
  title = "(\\#tab:slope-tab) Parameter estimates for `m16` and `m16\\_rs`.",
  CSS = list(
    css.table = "+font-size: 0.8em; +font-family: Arial;",
    css.footnote = "font-size: 0.8em;"
    )
  )
```

```{r plot, eval=FALSE, fig.width=8, fig.height=3, fig.cap = "Model predictions (red lines) for `m16` and `m16\\_rs`."}
plot_model(m16, type = "eff", terms = c("temp_90 [all]"), title = "`m16`", show.data = TRUE) + labs(y = "Predicted\nspawn date") |
plot_model(m16_rs, type = "eff", terms = c("temp_90 [all]"), title = "`m16_rs`", show.data = TRUE) + labs(y = "") + 
  plot_annotation(tag_levels = "A")

check_model(m16, check = c("qq", "residuals", "homogeneity", "normality"))
check_model(m16_rs, check = "vif")

```

The random slope model (`m16_rs`) substantially improved fit (ΔAIC = 510), reduced RMSE (2.02 → 1.78 days), and slightly increased conditional R² (0.981 → 0.985). However, the marginal R² declined from 0.714 to 0.698, reflecting a redistribution of explanatory power from fixed to random effects. This shift is expected when site-specific variation in temperature responses is modeled explicitly, and suggests that temperature sensitivity varies meaningfully among stream reaches.

### Partitioning Variation Between Nonlinearity and Heterogeneity

To determine whether the **quadratic temperature term remained necessary** in the presence of random slopes, we re-fit the random slope model with and without `I(temp_90^2)` using maximum likelihood (ML).

```{r m16-rs-noquad, echo=TRUE}
m16_rs <- lmer(
  yday ~ temp_90 + I(temp_90^2) + stream + year + (1 + temp_90 | COMID), 
  data = df_mod, REML = FALSE
  )
m16_rs_noquad <- lmer(
  yday ~ temp_90 + stream + year + (1 + temp_90 | COMID),
  data = df_mod, REML = FALSE
  )
```

```{r m16-rs-noquad-tabs}
aic_tab <- compare_aic(
  m16_rs, m16_rs_noquad
  )
perf_tab <- compare_performance(
  m16_rs, m16_rs_noquad,
  estimator = "ML", rank = TRUE, metrics = "common"
  ) 

lm_tab <- aic_tab |> 
  left_join(perf_tab, by = c("Model"="Name")) |> 
  select(Model, df, AIC, delta_AIC=delta, R2_marginal, R2_conditional, RMSE, ICC) |> 
  mutate(across(where(is.numeric), ~ round(., 3))) |>
  write_csv(here::here("tables","lm-model-comparison-ran-slopes-noquad.csv"))
```

```{r m16-rs-noquad-aic}
lm_tab |>
  kable(
    caption = "Model selection for `m16\\_rs` vs. `m16\\_rs\\_noquad`."
  ) |> 
  kable_styling(latex_options = "hold_position")
```

```{r m16-re-quad-rs-2-plot, fig.width=8, fig.height=3, fig.cap = "Model predictions (red lines) for `m16\\_rs` and `m16\\_rs\\_noquad`."}
plot_model(m16_rs, type = "eff", terms = c("temp_90 [all]"), show.data = TRUE, title = "`m16_rs`") + labs(y="Predicted\nspawn date") |
plot_model(m16_rs_noquad, type = "eff", terms = c("temp_90 [all]"), show.data = TRUE, title = "`m16_rs_noquad`") + labs(y="") + 
  plot_annotation(tag_levels = "A")
```

The full model including both quadratic temperature and random slopes (`m16_rs`) outperformed the linear version (`m16_rs_noquad`) by ΔAIC = 20.4, despite only one additional degree of freedom. RMSE and R² values were nearly identical, but the full model retained a slightly better fit, particularly at the tails of the temperature distribution. This indicates that while **random slopes capture most of the temperature-related variation**, the quadratic term meaningfully refines the relationship without overfitting or destabilizing the model.

### Summary of random slopes and nonlinearity

To account for site-level variation in thermal sensitivity, we extended this model by allowing COMID-specific random slopes for temperature. This significantly improved model fit (ΔAIC = 510), reduced prediction error (RMSE = 1.78 days), and increased conditional R², indicating that variation in temperature response among stream reaches was substantial and better captured as a random effect.

We then tested whether the quadratic temperature term remained necessary when random slopes were included. The full model with both random slopes and a quadratic temperature effect provided better support (ΔAIC = 20.4) than the linear version, suggesting that each component contributed complementary information. We retained this final model (`m16_rs`) as it provided strong predictive performance while acknowledging both general and site-specific patterns in temperature–spawn timing relationships.

## Interactions

To assess whether fixed-effect interactions provide additional explanatory power beyond what is captured by random slopes, we tested two models: one with a `temp_90 × stream` interaction (`m201`) and one with a `temp_90 × year` interaction (`m202`). Both were compared to the baseline random slope model with quadratic temperature (`m16_rs`).

```{r interact-mods, echo=TRUE}
m201 <- lmer(yday ~ temp_90 * stream + I(temp_90^2) + year + (1 + temp_90 | COMID), data = df_mod, REML = FALSE)
m202 <- lmer(yday ~ temp_90 * year + I(temp_90^2) + stream + (1 + temp_90 | COMID), data = df_mod, REML = FALSE)
```

```{r interact-tabs}
aic_tab <- compare_aic(
  m16_rs, m201, m202
  )
perf_tab <- compare_performance(
  m16_rs, m201, m202,
  estimator = "ML", rank = TRUE, metrics = "common"
  ) 

lm_tab <- aic_tab |> 
  left_join(perf_tab, by = c("Model"="Name")) |> 
  select(Model, df, AIC, delta_AIC=delta, R2_marginal, R2_conditional, RMSE, ICC) |> 
  mutate(across(where(is.numeric), ~ round(., 3))) |>
  write_csv(here::here("tables","lm-model-comparison-ran-slopes-interact.csv"))
```

```{r interact-aic}
lm_tab |>
  kable(
    caption = "Model selection for `m201` vs. `m202`."
  ) |> 
  kable_styling(latex_options = "hold_position")
```

```{r interact-tab, eval=FALSE}
tab_model(
  m16_rs, m201, m202,
  dv.labels = c("m16_rs", "m201: temp_90 * stream", "m202: temp_90 * year"),
  title = "(\\#tab:interact-tab) Parameter estimates for interaction models.", 
  CSS = list(
    css.table = "+font-size: 0.8em; +font-family: Arial;",
    css.footnote = "font-size: 0.8em;"
    )
  )
```

```{r interact-plots, fig.width=8, fig.height=3, fig.cap="Predicted spawn timing."}
# plot_model(m16_re_quad_rs, type = "eff", terms = c("temp_90 [all]"), show.data = TRUE)
# plot_model(m201, type = "eff", terms = c("temp_90 [all]"), show.data = TRUE)
plot_model(m201, type = "int", terms = c("temp_90 [all]"), show.data = TRUE, title = "m201") + labs(y = "Predicted\nspawn date") |
# plot_model(m202, type = "eff", terms = c("temp_90 [all]"), show.data = TRUE)
plot_model(m202, type = "int", terms = c("temp_90 [all]"), show.data = TRUE, title = "m202") + 
  labs(y = "")
```

Model `m202` showed a large AIC improvement (ΔAIC ≈ -1397), but inspection of its predicted effects revealed implausible temperature relationships—specifically, an inverted quadratic curve inconsistent with biological expectations. This suggests overfitting or confounding in the interaction structure.

Model `m201` produced biologically reasonable predictions and modest AIC improvement (ΔAIC ≈ -18), but most interaction terms were non-significant, and variance explained (R²) remained nearly unchanged. These results indicate that stream-specific variation in thermal sensitivity is already well-captured by the random slope structure.

Given the limited inferential gain and added complexity of the interaction models, we retained `m16_rs` (quadratic temperature with COMID-specific random slopes) as our final model.

\newpage 

# Model interpretation

The final model included a linear and quadratic effect of temperature (`temp_90`, `I(temp_90^2)`), additive fixed effects for `stream` and `year`, and a random intercept and slope for temperature by `COMID`:

```{r fin-mod, echo=TRUE}
# final model sturcture
mod_final <- lmer(
  yday ~ temp_90 + I(temp_90^2) + stream + year + (1 + temp_90 | COMID), 
  data = df_mod, REML = TRUE
  )
```

```{r get-temp-mean}
# get means for back transformation later
mean_temp <- mean(model_data$temp_90, na.rm = TRUE)
sd_temp <- sd(model_data$temp_90, na.rm = TRUE)
```

This model balances explanatory power, biological realism, and parsimony. It captures both general patterns in spawn timing (via fixed effects) and local deviations in temperature response (via random slopes), and will serve as the basis for diagnostics, prediction, and ecological interpretation.

## Model parameters and performance

```{r fin-param}
params <- model_parameters(mod_final)
params |> 
  select(-CI, -t, -df_error) |> 
  kable(
    caption = "Parameter estimates for mod\\_final.", 
    digits = 2
  ) |> 
  kable_styling(latex_options = "hold_position")
```

```{r fin-perf}
model_performance(mod_final) |>
  kable(
    caption = "Model performance for mod\\_final."
  ) |> 
  kable_styling(latex_options = "hold_position")
```

Parameter estimates (Table \@ref(tab:fin-param)) indicate a significant nonlinear effect of temperature on spawn timing, with the quadratic term (–0.85) confirming a concave-down relationship—i.e., spawn timing advances with increasing temperature, but levels off at high temperatures.

Most stream and year effects were significant, capturing expected spatiotemporal structure in spawn timing. Notably, Big, Camas, and Loon were not significantly different from the reference level (Bear Valley).

The random effects structure reveals substantial variation across COMIDs. The standard deviation for random intercepts (√τ₀₀ = 7.05) and random slopes for `temp_90` (√τ₁₁ = 3.55) indicates strong spatial heterogeneity in both baseline timing and temperature sensitivity (Table \@ref(tab:fin-param)). The intraclass correlation (ICC) was high (0.95), reflecting strong grouping structure at the COMID level (Table \@ref(tab:fin-perf)).

Model fit was excellent: the marginal R² (variance explained by fixed effects) was 0.698, and the conditional R² (fixed + random effects) was 0.985 (Table \@ref(tab:fin-perf)). This suggests that the majority of explanatory power is derived from spatially varying thermal responses captured by the random slopes, with additional structure provided by the fixed effects.


## Residual diagnostics

Model diagnostics for the final model were generally strong (Figure \@ref(fig:diagnostics)). The posterior predictive check shows excellent agreement between the observed and model-predicted distributions of spawn timing, with overlapping density curves and no major deviations.

Plots of linearity and homoscedasticity indicate acceptable model performance. While the residual vs. fitted plot shows a slight trend, it does not appear strong enough to invalidate model assumptions. The spread of residuals is approximately constant across fitted values, though there is minor funneling at the lower end, likely reflecting skew in early spawn dates.

Influential observations are limited. A few data points exceed standard influence thresholds (\|standardized residual\| \> 2 and high leverage), but none are extreme enough to warrant removal, and their leverage is modest. The model appears robust to outliers.

Collinearity is low: variance inflation factors (VIFs) for all fixed effects are well below the conservative threshold of 5, suggesting little concern about multicollinearity.

The normal Q-Q plot of residuals shows slight right-skew and some heavy tails, but the distribution is reasonably close to normal. Similarly, random effect Q-Q plots for intercepts and slopes show mostly linear trends with slight deviation at the tails, indicating acceptable assumptions for the mixed-effects structure.

Overall, the model shows no violations of key assumptions and is suitable for inference and prediction.

```{r diagnostics, fig.width=8, fig.height=9, fig.cap="Residual diagnostics for mod\\_final."}
check_model(
  mod_final,
  base_size = 8, size_title = 10)
# check_model(mod_final, check = c("vif", "qq", "residuals", "homogeneity", "normality"))
# check_model(mod_final, check = c("homogeneity"))
```

```{r sim-resid, eval=FALSE}
simulated_residuals <- simulate_residuals(mod_final)

head(residuals(simulated_residuals))
DHARMa::testUniformity(simulated_residuals, plot = TRUE)
check_residuals(simulated_residuals)
check_model(simulated_residuals, size_dot = 1.5)
```

```{r residuals-comid, eval=FALSE, fig.height=8, fig.cap="Residuals by COMID."}
# --- Step 1: Add predicted values and residuals ---
df_mod2 <- df_mod

df_mod2$resid <- residuals(mod_final)
df_mod2$pred <- predict(mod_final)

ggplot(df_mod2, aes(x = reorder(COMID, resid, FUN = median), y = resid)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.3) +
  facet_wrap(~stream, scales = "free_x") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "COMID", y = "Residual (Observed - Predicted)", title = "Residuals by COMID") +
  theme_minimal() +
  # coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Identify Outlier Observations Within COMIDs
# You could flag specific observations like this:

df_mod2 <- df_mod2 %>%
  mutate(outlier_obs = abs(resid) > 2)  # or 3 if you want stricter filtering

# Then you can examine:
# Which years or streams have repeated outliers?
# Are outliers clustered in particular COMIDs, or dispersed?

# comid_resids <- df_mod2 %>%
#   group_by(COMID) %>%
#   summarise(
#     mean_resid = mean(resid, na.rm = TRUE),
#     n = n()
#   ) %>%
#   mutate(outlier = abs(mean_resid) > 3)
# 
# ggplot(comid_resids, aes(x = reorder(COMID, mean_resid), y = mean_resid, fill = outlier)) +
#   geom_col() +
#   scale_fill_manual(values = c("FALSE" = "gray70", "TRUE" = "red")) +
#   geom_hline(yintercept = 0, linetype = "dashed") +
#   labs(title = "Mean Model Residual by COMID",
#        subtitle = "Outliers defined as |residual| > 3",
#        x = "COMID",
#        y = "Mean Residual (Observed - Predicted)") +
#   coord_flip() +
#   theme_minimal()
```

```{r dharma, eval=FALSE}
# sim_resid <- simulateResiduals(mod_final, n = 500, re.form = NULL)
# plot(sim_resid, quantreg=TRUE)
# # plotQQunif(sim_resid)
# testUniformity(sim_resid)
# testDispersion(sim_resid)
# testQuantiles(sim_resid)
# plotResiduals(sim_resid, form = df_mod$temp_90)
# plotResiduals(sim_resid, form = df_mod$stream)
# plotResiduals(sim_resid, form = df_mod$year)
# testOutliers(sim_resid)
```

## Predictions against original data

Model predictions closely matched observed spawn timing, with predicted values aligning well along the 1:1 line (Figure \@ref(fig:preds)). This supports strong overall model fit.

```{r preds, fig.width=5, fig.height=3, fig.cap = "Predicted vs. observed spawn timing for Chinook Salmon across all years and streams. The dashed line shows the 1:1 line. Points represent individual redd observations."}

# Estimate predictions on the model dataset
pred_data <- estimate_expectation(mod_final)
# head(pred_data)

# add original response
pred_data$yday <- df_mod$yday

# plot
pred_data |>
  ggplot(aes(x = fixed_date + yday, y = fixed_date + Predicted)) +
  geom_line(
    aes(x = fixed_date + yday, y = fixed_date + yday), 
    linetype = "dashed") +
  geom_point() + 
  scale_x_date(date_breaks = "2 weeks", date_labels = "%d %b") + 
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") + 
  labs(
    x = "Observed Spawn Day of Year",
    y = "Predicted Spawn Day of Year",
    title = "Predicted vs. Observed Spawn Timing"
  ) 
```

## Population-level effects

### Marginal means and contrasts of `yday` at each factor level

We estimated marginal mean of `yday` at each factor level, averaging over the random effects, to provide an overall estimate of the effect in the population (Figure \@ref(fig:means-panel)).

```{r means-panel, fig.width=8, fig.height=8, fig.cap = "Predicted mean spawn dates by stream (A), year (B) and stream and year (C), from the final mixed-effects model. Black points with black lines (A, B), and colored points with horizontal lines (C) represent estimated marginal means and 95\\% confidence intervals. Boxplots in panels A and B show the distribution of observed redd counts by group, with individual data points in grey. The modeled predictions represent marginal means accounting for fixed effects and averaged over random effects."}

# Estimate means for population-level effects (both)
means <- estimate_means(mod_final, by = c("stream", "year"), estimate = "average")
# Estimate means for population-level effects
means_stream <- estimate_means(mod_final, by = "stream", estimate = "average")
means_year <- estimate_means(mod_final, by = "year", estimate = "average")


# Plot both
p.means <- plot(means) + 
  labs(x = "", y = "Mean of yday (day of year)", color = "Year") + 
  coord_flip() + 
  scale_color_manual(values = cols.years) 
# p.means


# Plot Streams
# plot(means_stream, point = list(alpha = 0.1, width = 0.1)) 

p.means.stream <- df_mod |> 
  ggplot(aes(x = stream, y = fixed_date + yday)) +
  coord_flip() + 
  geom_boxplot(aes(fill = stream)) +
  geom_jitter(width = 0.1, height = 0, alpha = 0.25, size = 1, color = "grey") +
  geom_line(
    data = means_stream, 
    aes(y = fixed_date + Mean, group = 1),
    linewidth = 1) +
  geom_pointrange(
    data = means_stream,
    aes(y = fixed_date + Mean, 
        ymin = fixed_date + CI_low, 
        ymax = fixed_date + CI_high),
    size = 1, color = "black") + 
  scale_x_discrete(limits = rev) + 
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") + 
  scale_fill_manual(values = cols.streams) +
  labs(x = "", y = "") + 
  guides(fill = "none")


# Plot Years
# plot(means_year, point = list(alpha = 0.1, width = 0.1)) 

p.means.year <- df_mod |> 
  ggplot(aes(x = year, y = fixed_date + yday)) +
  coord_flip() + 
  geom_boxplot(aes(fill = year)) +
  geom_jitter(width = 0.1, height = 0, alpha = 0.25, size = 1, color = "grey") +
  geom_line(
    data = means_year, 
    aes(y = fixed_date + Mean, group = 1), linewidth = 1) +
  geom_pointrange(
    data = means_year,
    aes(y = fixed_date + Mean, 
        ymin = fixed_date + CI_low, 
        ymax = fixed_date + CI_high),
    size = 1, color = "black") + 
  scale_x_discrete(limits = rev) + 
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") + 
  scale_fill_manual(values = cols.years) +
  labs(x = "", y = "") + 
  guides(fill = "none")

# Panel 
p.means.panel <- (p.means.stream | p.means.year) / p.means  + 
  plot_annotation(
    tag_levels = "A"
  )
p.means.panel
```

Significant differences in spawn timing were observed between many stream pairs (Table \@ref(tab:contrasts-stream)), particularly involving Loon (later spawning) and Sulphur (earlier spawning). For example, fish in Loon spawned significantly later than in Bear Valley, Camas, and Elk, while Sulphur exhibited significantly earlier timing than all other streams except Elk. These patterns reflect spatial heterogeneity in temperature and elevation across streams that is not fully captured by fixed effects alone.

```{r contrasts-stream}
contrasts_stream <- estimate_contrasts(mod_final, contrast = "stream", estimate = "average")
contrasts_stream |> 
  write_csv(here::here("tables","contrasts-stream.csv"))
contrasts_stream |> 
  kable(
    caption = "Pairwise contrasts among stream effects on predicted spawn timing. Contrasts represent estimated differences in predicted spawn day of year between streams from the final model. Positive values indicate later predicted spawn timing in the first stream compared to the second. P-values are uncorrected.", 
    digits = 2
  ) |> 
  kable_styling(latex_options = "hold_position")
```

There was a clear trend toward later spawning over the four-year period (Table \@ref(tab:contrasts-year)). Spawning in 2005 occurred significantly later than in all previous years. Differences between 2002 and 2003 were not statistically significant, but later years (2004 and especially 2005) were associated with a progressive delay in mean spawn timing. This temporal shift likely reflects interannual variability in temperature and flow conditions.

```{r contrasts-year}
contrasts_year <- estimate_contrasts(mod_final, contrast = "year", estimate = "average")
contrasts_year |> 
  write_csv(here::here("tables","contrasts-year.csv"))
contrasts_year |> 
  kable(
    caption = "Pairwise contrasts among year effects on predicted spawn timing. Contrasts represent estimated differences in predicted spawn day of year between years from the final model. Positive values indicate later spawning in the first year compared to the second. P-values are uncorrected.", 
    digits = 2
  ) |> 
  kable_styling(latex_options = "hold_position")
```

### Estimating response vs. relation

To visualize the model's predictions across the temperature gradient, we estimated the relationship between spawn timing and 90-day pre-spawn mean temperature (`temp_90`) for different groupings: overall, by stream, and by year. This approach allows us to assess both general trends and context-specific responses.

Stream-specific predictions (see plot suggestion below) show a consistent pattern: spawn timing increases nonlinearly with 90-day mean stream temperature, leveling off at high temperatures. This plateau is consistent with biological expectations, as spawning may be constrained by environmental or physiological thresholds. Stream-to-stream variation in predicted timing reflects both fixed stream effects and COMID-specific random intercepts and slopes.

Year-specific predictions similarly show consistent thermal responses across years, with modest offsets in average spawn timing due to year effects. These predictions further validate the model's generalizability and temporal consistency.

In addition, a combined stream-by-year plot (e.g., facet grid) confirms that the final model captures heterogeneity in both space and time without overfitting. Lines track the raw data closely across groups, particularly in mid-range temperatures where most observations are concentrated.

Together, these plots indicate that the final model effectively captures both nonlinear temperature effects and spatial variation in thermal sensitivity, while maintaining interpretability and predictive strength.

When stratified by stream and year, predictions captured both the nonlinear temperature response and variation in baseline spawn timing across sites and years (Figure \@ref(fig:preds-by-group)). The curvature was consistent across years, while intercept shifts reflected known spatial patterns (e.g., later spawning in warmer, downstream reaches). These results confirm that the model accurately describes both average and context-specific phenological responses to temperature.

```{r preds-by-group, fig.width=8, fig.height=6, fig.cap = "Predicted relationship between spawn timing and 90-day pre-spawn mean temperature by stream and year. Lines represent model predictions from the final mixed-effects model. Colored points show observed redd timing, shaded ribbons represent 95% confidence intervals for predictions."}

# plot(estimate_relation(mod_final, by = "temp_90"))
# plot(estimate_relation(mod_final, by = c("mean_elevation")))

# 1. Create a base grid for prediction (one line per stream–year combo)
grid_base <- df_mod %>%
  group_by(stream, year) %>%
  summarise(
    min_temp = min(temp_90, na.rm = TRUE),
    max_temp = max(temp_90, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  do(data.frame(
    stream = .$stream,
    year = .$year,
    temp_90 = seq(.$min_temp, .$max_temp, length.out = 100)
  ))

# 2. Get predictions with standard errors (fixed effects only)
pred_out <- predict(mod_final,
                    newdata = grid_base,
                    re.form = NA,  # population-level (no random effects)
                    se.fit = TRUE,
                    allow.new.levels = TRUE)

# 3. Add predictions and 95% CI to grid
grid_base$yday_pred <- pred_out$fit
grid_base$yday_se <- pred_out$se.fit
grid_base$yday_lower <- grid_base$yday_pred - 1.96 * grid_base$yday_se
grid_base$yday_upper <- grid_base$yday_pred + 1.96 * grid_base$yday_se

# # add original response
df_mod$temp_90_raw <- df_mod$temp_90 * sd_temp + mean_temp
grid_base$temp_90_raw <- grid_base$temp_90 * sd_temp + mean_temp

# 4. Plot with confidence ribbon
df_mod |> 
  ggplot(aes(x = temp_90_raw, y = fixed_date + yday, color = stream)) +
  facet_wrap(~year) +
  geom_point(alpha = 0.3) +
  # geom_ribbon(data = grid_base,
  #             aes(x = temp_90_raw,
  #                 ymin = fixed_date + yday_lower,
  #                 ymax = fixed_date + yday_upper,
  #                 fill = stream),
  #             alpha = 0.2, color = NA) +
  geom_line(data = grid_base,
            aes(x = temp_90_raw, y = fixed_date + yday_pred, color = stream),
            linewidth = 1) +
  scale_color_manual(values = cols.streams) +
  scale_fill_manual(values = cols.streams) +
  scale_y_date(date_breaks = "2 weeks", date_labels = "%d %b") +
  labs(
    x = "90-day Mean Temperature Pre-Spawn (°C)",
    y = "Predicted Spawn Day of Year",
    color = "",
    fill = ""
  )

# save plot
# path <- here::here("plots", "Figure_02")
# ggsave(
#   glue::glue("{path}.pdf"), 
#   plot = last_plot(), 
#   device = cairo_pdf,
#   scale = 1.2, 
#   width = 18, 
#   height = 15,
#   units = "cm" 
#   )
# pdftools::pdf_convert(
#   pdf = glue::glue("{path}.pdf"),
#   filenames = glue::glue("{path}.png"),
#   format = "png", 
#   dpi = 300
#   )
```

## Group-level effects (deviations from fixed effects)

```{r ranefs}
random <- estimate_grouplevel(mod_final)

# Make random wide
random_wide <- random |> 
  select(Level, Parameter, Coefficient) |>
  pivot_wider(
    names_from = Parameter, 
    values_from = Coefficient
  ) |> 
  rename(COMID = Level, Intercept = `(Intercept)`, Slope = temp_90) |>
  left_join(xref_comid_stream, by = "COMID") |> 
  left_join(df_elev_slope |> mutate(COMID = as.character(COMID)), by = "COMID") 
```

Random intercepts and slopes varied considerably among COMIDs, reflecting spatial heterogeneity in both average spawn timing and thermal sensitivity (Figure \@ref(fig:ranefs-plot)A). We found considerable spread in intercepts, reflecting differences in average spawn timing between reaches. The random slopes for `temp_90` likewise varied meaningfully across COMIDs, indicating that temperature–spawn timing relationships are not constant across space.

Sites with earlier average spawn timing (lower intercepts) generally exhibited stronger positive responses to temperature (higher slopes), while later-spawning sites tended to show weaker temperature effects, a pattern also evident in the weak negative correlation between intercepts and slopes (r = -0.2; Figure \@ref(fig:ranefs-plot)B). This indicates that reaches with earlier average spawn timing (i.e., negative intercepts) tend to exhibit stronger temperature sensitivity (i.e., steeper positive slopes), whereas later-spawning reaches show weaker responses to temperature. Biologically, this suggests that early-spawning populations are more phenologically plastic and adjust their timing more closely to thermal cues, while late-spawning populations may be constrained by other factors—such as photoperiod, migration fatigue, or compressed spawning windows—resulting in diminished thermal responsiveness. These findings highlight spatial heterogeneity in phenological flexibility, with potential implications for how different populations may respond to climate change.

```{r ranefs-plot, fig.width=8, fig.height=9, fig.cap = "(A) COMID-specific random parameter estimates for intercepts (left) and slopes (right). Points represent best linear unbiased predictions (BLUPs) from the final model, with horizontal bars indicating ±1.96 standard errors. (B) Correlation between random intercepts and slopes for 90-day temperature across COMIDs. Each point represents a stream reach (COMID)."}

# Plot forest
p.re.forest <- plot(random) +
  geom_hline(yintercept = 0, linetype = "dashed") + 
  theme(axis.text.y = element_blank()) +
  labs(x = "Level (COMID)")


# Calculate correlation between intercepts and slopes
cor_val <- cor(random_wide$Intercept, random_wide$Slope)

# Plot cor
p.re.cor <- ggplot(random_wide, aes(x = Intercept, y = Slope)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  annotate(
    "text",
    x = min(random_wide$Intercept), 
    y = max(random_wide$Slope),
    label = paste0("r = ", round(cor_val, 2)), 
    hjust = 0, vjust = 1.5) +
  labs(
    # title = "Random Intercepts vs. Slopes for temp_90",
    x = "Random Intercept\n(Average Spawn Timing)",
    y = "Random Slope\n(Thermal Sensitivity)",
  )

p.re.forest / p.re.cor +
  plot_layout(heights = c(1.75,1)) + 
  plot_annotation(
    # title = "Random Effects for 90-day Pre-Spawn Temperature",
    tag_levels = "A"
  )

# save plot
# path <- here::here("plots", "Figure_02")
# ggsave(
#   glue::glue("{path}.pdf"), 
#   plot = last_plot(), 
#   device = cairo_pdf,
#   scale = 1.2, 
#   width = 18, 
#   height = 15,
#   units = "cm" 
#   )
# pdftools::pdf_convert(
#   pdf = glue::glue("{path}.pdf"),
#   filenames = glue::glue("{path}.png"),
#   format = "png", 
#   dpi = 300
#   )
```

When grouped by stream, Bear Valley and Big Creek exhibited early average spawn timing and high thermal sensitivity, while Sulphur and Marsh Creeks had later average timing with flatter temperature responses (Figure \@ref(fig:ranefs-box)).

```{r ranefs-box, fig.width=8, fig.height=3, fig.cap = "Boxplots of random intercepts and slopes for 90-day pre-spawn temperature by stream. Each box represents the distribution of best linear unbiased predictions (BLUPs) for a COMID's random intercept (average spawn timing) or slope (thermal sensitivity). Bars are colored by stream."}
p.re.int.box <- random_wide |> 
  ggplot(aes(x = stream, y = Intercept, fill = stream)) +
  geom_boxplot() + 
  geom_jitter(width = 0.2, alpha = 0.3) + 
  scale_fill_manual(values = cols.streams) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = "none") +
  labs(
    x = "",
    y = "Random Intercept\n(Average Spawn Timing)",
  )

p.re.slp.box <- random_wide |> 
  ggplot(aes(x = stream, y = Slope, fill = stream)) +
  geom_boxplot() + 
  geom_jitter(width = 0.2, alpha = 0.3) + 
  scale_fill_manual(values = cols.streams) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = "none") +
  labs(
    x = "",
    y = "Random Slope\n(Thermal Sensitivity)",
  )

p.re.int.box + p.re.slp.box +
  plot_layout(guides = "collect") + 
  plot_annotation(
    # title = "Random Intercepts and Slopes for 90-day Pre-Spawn Temperature by Stream",
    tag_levels = "A"
  )
```

However, when examining individual random effects for each COMID and stream, we observed considerable variation in both intercepts and slopes within streams (Figure \@ref(fig:ranefs-bar)). For example, Bear Valley and Big Creek had some of the earliest average spawn timings, but also exhibited a wide range of thermal sensitivities. In contrast, Sulphur Creek had later average spawn timing but also showed considerable variability in its response to temperature.

```{r ranefs-bar, fig.width=8, fig.height=6, fig.cap = "Random intercepts and slopes for 90-day pre-spawn temperature by stream. Each bar represents the best linear unbiased prediction (BLUP) for a COMID's random intercept (average spawn timing) or slope (thermal sensitivity). Bars are colored by stream."}

p.re.int.bar <- random_wide |> 
  ggplot(aes(x = reorder(COMID, Intercept), y = Intercept, fill = stream)) +
  geom_col() + 
  coord_flip() + 
  scale_fill_manual(values = cols.streams) + 
  labs(
    x = "COMID", fill = "Stream",
    y = "Random Intercept\n(Average Spawn Timing)"
  ) + 
  theme(axis.text.y = element_blank())

p.re.slp.bar <- random_wide |> 
  ggplot(aes(x = reorder(COMID, Slope), y = Slope, fill = stream)) +
  geom_col() + 
  coord_flip() + 
  scale_fill_manual(values = cols.streams) + 
  labs(
    x = "COMID", fill = "Stream",
    y = "Random Slope\n(Thermal Sensitivity)"
  ) + 
  theme(axis.text.y = element_blank())

p.re.int.bar + p.re.slp.bar + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    tag_levels = "A"
  )
```

Variation in temperature–spawn timing relationships across stream reaches (COMIDs) as estimated from the final mixed-effects model is shown in Figure \@ref(fig:ranefs-comid)). While the overall relationship is positive and nonlinear, individual COMID slopes and intercepts vary considerably. Some reaches show steeper increases in spawn timing with temperature (i.e., stronger thermal sensitivity), while others are relatively flat, indicating a weaker or more buffered response. Grouping by stream shows that some streams (e.g., Bear Valley, Marsh) exhibit tightly clustered trajectories, while others (e.g., Camas, Big) show more divergence. This variation likely reflects fine-scale differences in local hydrology, geomorphology, or biological factors that influence how fish respond to thermal cues within stream systems. The consistency of the overall trend, despite local heterogeneity, supports the biological relevance of temperature in structuring spawn timing.

```{r ranefs-comid, fig.width=7, fig.height=5, fig.cap = "Predicted spawn timing by 90-day pre-spawn temperature and COMID. Each line represents the predicted spawn timing for a specific COMID, colored by stream. The black line and shaded ribbon represents the 95% confidence interval for the population-level predictions."}

me <- predict_response(mod_final, terms = c("temp_90 [all]", "COMID"), type = "random")
me2 <- predict_response(mod_final, terms = c("temp_90 [all]"))
# plot(me, show_data = TRUE, show_ci = FALSE) + scale_color_manual(values = "black") 

# back trandform temp_90
me$x <- me$x * sd_temp + mean_temp
me2$x <- me2$x * sd_temp + mean_temp

p.re.preds <- me |> 
  as_tibble() |> 
  left_join(xref_comid_stream, by = c("group" = "COMID")) |>
  ggplot(aes(x, fixed_date + predicted, group = group)) + 
  geom_line(aes(color = stream)) + 
  geom_ribbon(
    data = me2, 
    aes(x = x, ymin = fixed_date + conf.low, ymax = fixed_date + conf.high),
    alpha = 0.5) +
  geom_line(
    data = me2,
    aes(x = x, y = fixed_date + predicted), 
    linewidth = 2) +
  scale_color_manual(values = cols.streams) + 
  labs(
    x = "90-day Mean Temperature Pre-Spawn (°C)",
    y = "Predicted Spawn Day of Year",
    # title = "Predicted Spawn Timing by 90-day Pre-Spawn Temperature and COMID"
  )
p.re.preds
```

<!-- ## Elevation effects embedded in random structure -->

<!-- Although mean elevation was excluded as a fixed effect due to collinearity with temperature and inconsistent global directionality, examination of random effects against elevation reveals spatial structure that elevation helps explain (Figure X). Random intercepts (average spawn timing) showed positive relationships with elevation in some streams (e.g., Big Creek), where higher-elevation sites tended to have later average spawning relative to the population mean. In contrast, other streams (e.g., Bear Valley, Beaver) showed little or no elevation pattern. -->

<!-- Random slopes (thermal sensitivity to temperature) exhibited similarly idiosyncratic patterns. In some cases (e.g., Camas, Marsh), thermal sensitivity declined with elevation, suggesting that fish at higher elevations may respond less strongly to interannual temperature variability. In others, relationships were weak or even opposite in direction. -->

<!-- Taken together, these patterns indicate that elevation influences both average spawn timing and thermal sensitivity, but in ways that differ across streams. This heterogeneity justifies our decision to capture elevation-linked variation through COMID-level random effects rather than imposing a single fixed elevation term. -->

```{r ranefs-elev, eval=FALSE, fig.width=8, fig.height=6, fig.cap = "Relationship between `mean\\_elevation` and (A) random intercepts and (B) slopes for 90-day pre-spawn temperature, as well as `mean\\_elevation` and (C) spawn date (`yday`) and (D) `temp\\_90` . Points and lines are colored by stream, and solid lines represent linear fits."}

p.re.int.elev <- random_wide |> 
  ggplot(aes(x = mean_elevation, y = Intercept, color = stream)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = cols.streams) +
  labs(
    x = "Mean Elevation (m)",
    y = "Random Intercept\n(Average Spawn Timing)",
    color = "Stream"
  )

p.re.int.elev_high <- random_wide |> 
  filter(stream %in% c("Bear Valley","Marsh","Elk","Beaver")) |>
  ggplot(aes(x = mean_elevation, y = Intercept, color = stream)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = cols.streams) +
  labs(
    x = "Mean Elevation (m)",
    y = "Random Intercept\n(Average Spawn Timing)",
    color = "Stream"
  )
p.re.int.elev_low <- random_wide |> 
  filter(!stream %in% c("Bear Valley","Marsh","Elk","Beaver")) |>
  ggplot(aes(x = mean_elevation, y = Intercept, color = stream)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = cols.streams) +
  labs(
    x = "Mean Elevation (m)",
    y = "Random Intercept\n(Average Spawn Timing)",
    color = "Stream"
  )

p.re.slp.elev <- random_wide |> 
  ggplot(aes(x = mean_elevation, y = Slope, color = stream)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = cols.streams) +
  labs(
    x = "Mean Elevation (m)",
    y = "Random Slope\n(Thermal Sensitivity)",
    color = "Stream"
  )

p.re.slp.elev_high <- random_wide |> 
  filter(stream %in% c("Bear Valley","Marsh","Elk","Beaver")) |>
  ggplot(aes(x = mean_elevation, y = Slope, color = stream)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = cols.streams) +
  labs(
    x = "Mean Elevation (m)",
    y = "Random Slope\n(Thermal Sensitivity)",
    color = "Stream"
  )

p.re.slp.elev_low <- random_wide |> 
  filter(!stream %in% c("Bear Valley","Marsh","Elk","Beaver")) |>
  ggplot(aes(x = mean_elevation, y = Slope, color = stream)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = cols.streams) +
  labs(
    x = "Mean Elevation (m)",
    y = "Random Slope\n(Thermal Sensitivity)",
    color = "Stream"
  )

# p.re.int.elev + p.re.slp.elev +
#   # p.elev.yday + p.elev.temp + 
#   plot_layout(guides = "collect") + 
#   plot_annotation(
#     tag_levels = "A"
#   )

p.re.int.elev_high + p.re.slp.elev_high +
  p.re.int.elev_low + p.re.slp.elev_low +
  plot_layout(guides = "collect") + 
  plot_annotation(
    tag_levels = "A"
  )

```

# References
