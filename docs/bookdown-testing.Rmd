---
title: "Supplementary Materials"
subtitle: "Habitat heterogeneity and phenotypic variation: Site temperature largely predicts diverse spawning portfolios of an interior Chinook Salmon stock"
output:
  bookdown::pdf_document2:
    extra_dependencies: ["float"]
    latex_engine: lualatex
    toc: true
    number_sections: true
    toc_depth: 2
fontsize: 10pt
date: "`r format(Sys.time(), '%d %B, %Y')`"
editor_options: 
  chunk_output_type: console
bibliography: references.bib
csl: cjfas.csl
---

```{r setup, include=FALSE, cache=FALSE}
# chuck options
knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE, 
  cache = TRUE,
  fig.align = 'center', 
  fig.pos = "ht", 
  out.extra = ""
  )

# libraries
library(tidyverse)
library(knitr)
library(kableExtra)
library(here)
library(patchwork)
library(lemon)
library(lme4)
library(MuMIn)
library(sjPlot)
library(DHARMa)
library(visdat)
library(skimr)
library(broom)
library(easystats)
library(performance)
library(ggeffects)

# set gpplot theme to bw
theme_set(theme_bw(base_size = 12))

# palettes
cols.streams <- c(
  "Bear Valley" = "#55FF00",
  "Beaver" = "#7A8EF5",
  "Big" = "#FFFF00",
  "Camas" = "#E64C00",
  "Elk" = "#D7D79E",
  "Loon" = "#7AF5CA",
  "Marsh" = "#DF73FF",
  "Sulphur" = "#FFAA00"
  )

cols.years <- c(
  "2002" = "#1B9E77", 
  "2003" = "#D95F02", 
  "2004" = "#7570B3", 
  "2005" = "#E7298A", 
  "2001" = "#66A61E"
  )

# fixed date for better date axes
fixed_date <- as.Date("2000-12-31")

# functions
source(here("R/helper_fxs.R"))
```

```{r load-data, cache=FALSE}
# Spawn data -------------------------------------------------------------------
# data were compiled and clean in compile_mfsr_spawn.R and clean_mfsr_spawn.R
spawn_data_cleaned <- read_csv(here("data", "russ_spawn", "mfsr_spawn_cleaned.csv"))

# remove bad data
spawn_data <- spawn_data_cleaned |>
  filter(stream != "Knapp" & stream != "Cape Horn" & year != 2001) |> 
  mutate(
    UNIQUE_ID = as.factor(UNIQUE_ID), 
    year = as.factor(year), 
    stream = as.factor(stream), 
    COMID = as.factor(COMID), 
    DATE = mdy(DATE)
    ) |> 
  select(
    redd_id = UNIQUE_ID, COMID, spawn_date = DATE, stream, year, yday
  )

# Temp data --------------------------------------------------------------------
# temp data (see siegel_mfsr_temps.R)
df_temp <- readRDS(here::here("data/siegel_temperature/siegel_mfsr_comid.RDS"))

xref_comid_stream <- spawn_data |> 
  distinct(COMID, stream) 

# clean up
df_temp <- df_temp |>
  select(COMID, date = tim.date, temp = prd.stream_temp) |> 
  mutate(
    yday = yday(date), 
    year = as_factor(year(date)), 
    COMID = as.character(COMID)) |> 
  filter(COMID %in% spawn_data$COMID) |>
  filter(year %in% c("2002","2003","2004","2005")) |>
  left_join(xref_comid_stream, by = "COMID") 

# summarized temperature data (`out`), see (map_comid_temps.R)
load(here("data", "comid_temps.RData"))

temp_data <- out |>
  filter(period == "before" & duration %in% c(30, 60, 90)) |>
  pivot_wider(
    names_from = "duration", 
    values_from = avg_temp, 
    names_prefix = "temp_"
    ) |> 
  select(redd_id, COMID = comid, spawn_date, temp_30, temp_60, temp_90) |> 
  mutate(redd_id = as_factor(redd_id))


# Flow data --------------------------------------------------------------------
# raw flow data (see flow_calculations.R)
df_flows <- read_csv(here::here("data", "mfsr_flow.csv"))

# get day of year and year
df_flows <- df_flows |> 
  select(date = Date, flow_cfs = Flow) |> 
  mutate(yday = yday(date), year = as_factor(year(date))) |> 
  mutate(flow_csm = flow_cfs * 0.028316846592) |> 
  filter(!year == "2001")

# summarized flow data (see flow_calculations.R)
flow_data <- read_csv(here("data", "spawn_flows.csv"))

# elevation and slope from NHD -------------------------------------------------
df_elev_slope <- readRDS(here("data", "elevslope.rds")) |> 
  as_tibble() |> 
  mutate(mean_elevation = (MAXELEVSMO + MINELEVSMO) / 2 / 100) |> 
  select(COMID, slope = SLOPE, mean_elevation)


# Combine data -----------------------------------------------------------------
model_data <- spawn_data |>
  left_join(flow_data, by = "spawn_date") |> 
  left_join(temp_data |> select(-spawn_date,-COMID), by = "redd_id") |>
  left_join(df_elev_slope |> mutate(COMID = as.factor(COMID)), by = "COMID")

# fix bad slope value
model_data <- model_data |> 
  mutate(slope = ifelse(slope > 0.2, 0.002, slope))

# Finalize data ----------------------------------------------------------------
# df_mod <- model_data |>
#   select(yday, COMID, stream, year, 
#          temp_90_raw = temp_90, 
#          mean_elevation_raw = mean_elevation, 
#          slope_raw = slope) |>
#   mutate(temp_90 = scale2(temp_90_raw), 
#          mean_elevation = scale2(mean_elevation_raw), 
#          slope = scale2(slope_raw))

df_mod <- model_data |>
  select(yday, COMID, stream, year, temp_90, mean_elevation, slope) |> 
  mutate(temp_90 = scale2(temp_90), 
         mean_elevation = scale2(mean_elevation), 
         slope = scale2(slope))
```

\newpage

\renewcommand{\thesection}{S\arabic{section}}
\counterwithin{equation}{section}
\counterwithin{figure}{section}
\counterwithin{table}{section}

# Datasets

## Spawn timing data

Spawn timing data for Chinook salmon were collected from 2001 to 2005 in the MFSR. Because redds were not observed daily, we inferred spawn dates as the initial date (day of year) a completed redd was observed.

We removed data from 2001, and data from Knapp Creek and Cape Horn Creek, as these sites were not consistently sampled.

We spatially joined each redd GPS location to the NHDPlus Version 2 (Horizon Systems, 2018) to assign stream reaches based on a common identifier (COMID). The COMID is used to link redd data with covariate data associated with the stream reach on which it is located. A summary of the dataset is shown in Table \@ref(tab:spawn-summary).

```{r spawn-summary}
# spawn_data |>
#   slice_head(n = 5) |>
#   knitr::kable(
#     caption = "First five rows of the Chinook salmon redd dataset.",
#     format = "latex", position = "h!"
#   )

spawn_data |>
  slice_head(n = 5) |>
  knitr::kable(caption = "First five rows of the Chinook salmon redd dataset.") |> 
  kable_styling(latex_options = c("hold_position"))
```


### Evaluate Grouping structure

```{r comid-counts}
# How many COMIDs have <5 observations?
n_sparse_COMIDS_5 <- spawn_data |> 
  count(COMID, name = "n_redds") |> 
  filter(n_redds < 5) |> 
  nrow()
n_sparse_COMIDS_2 <- spawn_data |> 
  count(COMID, name = "n_redds") |> 
  filter(n_redds <= 2) |> 
  nrow()

# what percent of comids have <= 1 obervation?
n_perc_1 <- spawn_data |>
  count(COMID, name = "n_redds") |>
  filter(n_redds <= 1) |>
  nrow() / length(unique(spawn_data$COMID)) * 100

n_perc_2 <- spawn_data |>
  count(COMID, name = "n_redds") |>
  filter(n_redds <= 2) |>
  nrow() / length(unique(spawn_data$COMID)) * 100

n_perc_5 <- spawn_data |>
  count(COMID, name = "n_redds") |>
  filter(n_redds <= 5) |>
  nrow() / length(unique(spawn_data$COMID)) * 100
```

The structure of the data is repeated measures on COMIDs, and multiple years, shared across COMIDs within streams.

-   Redds observed at specific locations, `COMID`
-   Nested within `stream`
-   Observed across multiple `years`

Table \@ref(tab:comid-str) shows the number of COMIDs per stream, and Figure \@ref(fig:comid-str-plot) shows the number of observations (unique redds) per COMID.

Many `COMIDs` only have 1-2 observation, so the groups are not well sampled. There are `r n_sparse_COMIDS_5` COMIDs with \<5 redds (`r round(n_perc_5, 1)`%), `r n_sparse_COMIDS_2` with \<= 2. (`r n_perc_2`%). With \<5 obs/level, variance estimates can become unstable and lead to overfitting and absorbing noise (low AIC / high R2) and singular fits. Something to keep in mind during model fitting.

```{r comid-str, caption = "Number of COMIDs per stream."}
# number of comids per stream
spawn_data |> 
  distinct(stream, COMID) |> 
  count(stream, name = "n_COMIDs") |> 
  arrange(desc(n_COMIDs)) |> 
  kable(caption = "Number of COMIDs per stream (major tributaries).") |> 
  kable_styling(latex_options = c("hold_position"))
```

```{r comid-str-plot, fig.width=5, fig.height=3, fig.cap="Number of observations (redds) per COMID."}
# number of observations per COMID
spawn_data |> 
  count(COMID, name = "n_redds") |> 
  arrange(n_redds) |> 
  ggplot(aes(n_redds)) +
  geom_bar() + 
  scale_y_continuous(breaks = seq(0,10,1)) + 
  labs(title = "Number of obervations (redds) per COMID", 
       x = "Number of redds", 
       y = "Count") + 
  theme_bw()
```
